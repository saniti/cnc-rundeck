[ {
  "defaultTab" : "nodes",
  "description" : "Get key variables in a job and export",
  "executionEnabled" : true,
  "group" : "CNC/Configuration",
  "id" : "9f23ae51-e4ad-4b35-acfd-e3f48dca45b0",
  "loglevel" : "INFO",
  "name" : "get key vars v2",
  "nodeFilterEditable" : false,
  "options" : [ {
    "enforced" : true,
    "label" : "CNC POD",
    "name" : "cnc-pod",
    "required" : true,
    "valuesUrl" : "file:/opt/cw/options/cw-environments.json"
  } ],
  "plugins" : {
    "ExecutionLifecycle" : null
  },
  "scheduleEnabled" : true,
  "sequence" : {
    "commands" : [ {
      "description" : "get vars",
      "plugins" : {
        "LogFilter" : [ {
          "config" : {
            "captureMultipleKeysValues" : "true",
            "hideOutput" : "false",
            "logData" : "true",
            "regex" : "^(.+?)\\s*=\\s*(.+)"
          },
          "type" : "key-value-data-multilines"
        } ]
      },
      "script" : "file=/opt/cw/options/cw-environments.json\njq -r '..|objects|select(.name==\"CPOC\") | to_entries[] | .key+\"=\"+(.value|tostring)' $file\n\n#mgtdns=$(jq -r '.[] | select(.name==\"@option.cnc-pod@\").\"mgt-dns\"' /opt/cw/options/cw-environments.json)\n#datadns=$(jq -r '.[] | select(.name==\"@option.cnc-pod@\").\"data-dns\"' /opt/cw/options/cw-environments.json)\n#datavip=$(jq -r '.[] | select(.name==\"@option.cnc-pod@\").\"data-vip\"' /opt/cw/options/cw-environments.json)\n#mgtvip=$(jq -r '.[] | select(.name==\"@option.cnc-pod@\").\"mgt-vip\"' /opt/cw/options/cw-environments.json)\n\nif [ -f \"/opt/cw/tmp/@option.cnc-pod@.cwtoken\" ]; then cwtoken=$(cat /opt/cw/tmp/@option.cnc-pod@.cwtoken); else cwtoken=\"none\"; fi\nif [ -f \"/opt/cw/tmp/@option.cnc-pod@.cwticket\" ]; then cwticket=$(cat /opt/cw/tmp/@option.cnc-pod@.cwticket); else cwticket=\"none\"; fi\n#if [ \"$mgtdns\" == \"\" ]; then echo mgtdns=none; else echo mgtdns=$mgtdns;  fi\n#if [ \"$datadns\" == \"\" ]; then echo datadns=none; else echo datadns=$datadns;  fi\n#if [ \"$datavip\" == \"\" ]; then echo datavip=none; else echo datavip=$datavip;  fi\n#if [ \"$mgtvip\" == \"\" ]; then echo mgtvip=none; else echo mgtvip=$mgtvip;  fi\n#if [ \"$mgtvip\" == \"\" ]; then echo cwvip=none; else echo cwvip=$mgtvip;  fi\necho cwtoken=${cwtoken}\necho cwticket=${cwticket}\n"
    }, {
      "description" : "decode token",
      "plugins" : {
        "LogFilter" : [ {
          "config" : {
            "captureMultipleKeysValues" : "true",
            "hideOutput" : "false",
            "logData" : "true",
            "regex" : "^(.+?)\\s*=\\s*(.+)"
          },
          "type" : "key-value-data-multilines"
        } ]
      },
      "script" : "#out=$(echo '@data.cwtoken*@' | base64 -d -i)\n\n#echo DECODED=$out\n\n#tokenjson=$(echo $out | jq --raw-input --raw-output '. | split(\"}\")[1]+\"}\"')\n#echo $tokenjson |jq -r 'if (.exp > now) then echo \"expired=true\" else echo \"expired=false\" end'\n\n#echo '@data.cwtoken*@' | base64 -d -i | jq --raw-input --raw-output '. | split(\"}\")[1]+\"}\"' #| jq -r 'if (.exp > now) then \"true\" else \"false\" end'\necho '@data.cwtoken*@' | base64 -d -i | head -n1 | jq -r 'if ..|objects|select(has(\"exp\")).exp > now then \"token=expired\" else \"token=ok\" end'\ntrue\n"
    }, {
      "description" : "refresh token if required",
      "errorhandler" : {
        "jobref" : {
          "args" : "-cnc-vip ${option.cnc-pod}",
          "group" : "-DEMO",
          "name" : ".CNC - Auth",
          "nodeStep" : "true",
          "uuid" : "96e872a2-5704-4af6-96dc-47758e6049d9"
        },
        "keepgoingOnSuccess" : true
      },
      "script" : "if [ \"@data.token*@\" = \"expired\" ]\nthen\n    false\nelse\n    true\nfi"
    }, {
      "configuration" : {
        "export" : "mgtdns",
        "group" : "export",
        "value" : "${data.mgt-dns*}"
      },
      "nodeStep" : false,
      "type" : "export-var"
    }, {
      "configuration" : {
        "export" : "datadns",
        "group" : "export",
        "value" : "${data.data-dns*}"
      },
      "nodeStep" : false,
      "type" : "export-var"
    }, {
      "configuration" : {
        "export" : "datavip",
        "group" : "export",
        "value" : "${data.data-vip*}"
      },
      "description" : "datavip",
      "nodeStep" : false,
      "type" : "export-var"
    }, {
      "configuration" : {
        "export" : "mgtvip",
        "group" : "export",
        "value" : "${data.mgt-vip*}"
      },
      "description" : "mgtvip",
      "nodeStep" : false,
      "type" : "export-var"
    }, {
      "configuration" : {
        "export" : "cwvip",
        "group" : "export",
        "value" : "${data.mgt-vip*}"
      },
      "description" : "cwvip",
      "nodeStep" : false,
      "type" : "export-var"
    }, {
      "configuration" : {
        "export" : "cwtoken",
        "group" : "export",
        "value" : "${data.cwtoken*}"
      },
      "description" : "cwtoken",
      "nodeStep" : false,
      "type" : "export-var"
    }, {
      "configuration" : {
        "export" : "cwticket",
        "group" : "export",
        "value" : "${data.cwticket*}"
      },
      "description" : "cwticket",
      "nodeStep" : false,
      "type" : "export-var"
    } ],
    "keepgoing" : true,
    "strategy" : "node-first"
  },
  "uuid" : "9f23ae51-e4ad-4b35-acfd-e3f48dca45b0"
} ]
