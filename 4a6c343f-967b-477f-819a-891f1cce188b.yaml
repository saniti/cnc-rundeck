- defaultTab: nodes
  description: "Uses `nso` to generate a topology from the live network, and converts\
    \ into mermaid (markdown) format for WIKI page. \n---\n### Wiki Page\n[Topology](http://198.18.133.102:3000/simon/demo/wiki/Topology)"
  executionEnabled: true
  group: DEMO/Datacenter/Datacenter
  id: 4a6c343f-967b-477f-819a-891f1cce188b
  loglevel: INFO
  name: show topoloogy v3
  nodeFilterEditable: false
  options:
  - enforced: true
    label: NSO Environment
    name: env
    required: true
    valuesUrl: file:/opt/cw/options/nso-environment.json
  - label: Line Length
    name: line-length
    required: true
    value: --
  plugins:
    ExecutionLifecycle: null
  scheduleEnabled: true
  sequence:
    commands:
    - configuration:
        authentication: None
        checkResponseCode: 'false'
        file: /opt/cw/tmp/nso-topology.json
        headers: '{"accept": "application/json"}'
        method: GET
        printResponse: 'true'
        printResponseToFile: 'true'
        proxySettings: 'false'
        remoteUrl: http://proxy:7000/topology/${option.env}
        sslVerify: 'false'
        timeout: '1000000'
      description: Get Topology
      nodeStep: false
      type: edu.ohio.ais.rundeck.HttpWorkflowStepPlugin
    - description: Normalise device names
      plugins:
        LogFilter:
        - config:
            datatype: application/json
            sanitizeHtml: 'true'
            striped: 'true'
          type: render-datatype
      script: |+
        filein=/opt/cw/tmp/nso-topology.json
        fileout=/opt/cw/tmp/nso-topology-@job.execid@.json
        fileout1=/opt/cw/tmp/nso-topology-out.json
        jq '(.[][] | ..|select(has("name"))?).name |= (split(".")[0]) | (..|select(has("device-id"))?)."device-id" |= (split(".")[0])  ' $filein > $fileout

    - description: Build topology file
      plugins:
        LogFilter:
        - config:
            datatype: application/json
            sanitizeHtml: 'true'
            striped: 'true'
          type: render-datatype
      script: |-
        file=/opt/cw/tmp/nso-topology-@job.execid@.json
        outfile=/opt/cw/tmp/nso-topology-out.json
        echo '```mermaid' > $outfile
        echo 'flowchart TD' >> $outfile
        echo '%% updated: ' `date` >> $outfile
        jq -r '([..|objects|select(has("name")) | ([.name,"<br/>",.address]|join(""))]) as $a2 | ([..|objects|select(has("device-id"))."device-id"]) as $a1 | $a2+$a1 | unique[] | [(.|split("<")[0]),"(((",.,")))"]|join("")' $file >> $outfile
        jq -r '(.[][]| .name as $name | (..|select(has("live-status"))?) |."live-status"[][][] | (."device-id") as $remote | $name+" x@option.line-length@x|<- "+."local-interface"+"<br>"+."port-id"+" ->|"+$remote)' $file >> $outfile
        echo '```' >> $outfile
    - description: Show file
      exec: cat /opt/cw/tmp/nso-topology-out.json
    - jobref:
        args: -repo simon/demo -branch develop -file-path /opt/cw/tmp/nso-topology-out.json
          -file-name Topology -message "updated"
        group: git
        name: git - replace wiki file v2
        uuid: e81b5233-73ba-40a0-bc17-f6a78e606c30
    keepgoing: false
    strategy: node-first
  uuid: 4a6c343f-967b-477f-819a-891f1cce188b

