- defaultTab: nodes
  description: 'Provides CNC authentication towards a nominated host, and returns
    the token as `export.cnc-token`'
  executionEnabled: true
  group: .Auth
  id: dc1ad0cc-965d-4d8a-a1a7-fd04a3553cc2
  loglevel: INFO
  name: CNC - Auth v2
  nodeFilterEditable: false
  options:
  - enforced: true
    label: CNC POD
    name: cnc-vip
    required: true
    valuesUrl: file:/opt/cw/options/cw-environments.json
  - label: Crosswork Port
    name: cw-port
    required: true
    value: '30603'
  plugins:
    ExecutionLifecycle: null
  scheduleEnabled: true
  sequence:
    commands:
    - description: get Data
      plugins:
        LogFilter:
        - config:
            captureMultipleKeysValues: 'true'
            hideOutput: 'false'
            logData: 'true'
            regex: ^(.+?)\s*=\s*(.+)
          type: key-value-data-multilines
      script: "filein=/opt/cw/options/cw-environments.json\n#jq -r '.[] | select(.name==\"\
        @option.cnc-vip@\").\"mgt-vip\"' /opt/cw/options/cw-environments.json \njq\
        \ --raw-output '.[] | select(.value==\"@option.cnc-vip@\") | to_entries[]\
        \ |  [.key,.value]|join(\"=\")' $filein"
    - description: find credential
      plugins:
        LogFilter:
        - config:
            captureMultipleKeysValues: 'true'
            hideOutput: 'true'
            logData: 'true'
            regex: ^(.+?)\s*=\s*(.+)
          type: key-value-data-multilines
      script: |-
        echo user=$(cat '@data.pod-user*@')
        echo pass=$(cat '@data.pod-pass*@')
    - configuration:
        authentication: None
        checkResponseCode: 'false'
        headers: '{"Content-Type": "application/x-www-form-urlencoded"}'
        method: POST
        printResponse: 'true'
        printResponseToFile: 'false'
        proxySettings: 'false'
        remoteUrl: https://${data.mgt-vip*}:30603/crosswork/sso/v1/tickets?username=${data.user*}&password=${data.pass*}
        sslVerify: 'false'
        timeout: '30000'
      description: Auth to CNC
      nodeStep: false
      plugins:
        LogFilter:
        - config:
            invalidKeyPattern: \s|\$|\{|\}|\\
            logData: 'true'
            name: ticket
            regex: (.*)
          type: key-value-data
      type: edu.ohio.ais.rundeck.HttpWorkflowStepPlugin
    - configuration:
        authentication: None
        body: service=https://1.2.3.4/app-dashboard/app-dashboard
        checkResponseCode: 'false'
        headers: '{"Content-Type": "application/x-www-form-urlencoded"}'
        method: POST
        printResponse: 'true'
        printResponseToFile: 'false'
        proxySettings: 'false'
        remoteUrl: https://${data.mgt-vip*}:30603/crosswork/sso/v1/tickets/${data.ticket}
        sslVerify: 'false'
        timeout: '30000'
      nodeStep: false
      plugins:
        LogFilter:
        - config:
            invalidKeyPattern: \s|\$|\{|\}|\\
            logData: 'true'
            name: token
            regex: (.*)
          type: key-value-data
      type: edu.ohio.ais.rundeck.HttpWorkflowStepPlugin
    - description: save ticket and token data
      script: |-
        echo @data.ticket*@ > /opt/cw/tmp/@option.cnc-vip@.cwticket
        echo @data.token*@ > /opt/cw/tmp/@option.cnc-vip@.cwtoken
        echo @data.cnc-vip*@ > /opt/cw/tmp/@option.cnc-vip@.cwvip
    - configuration:
        export: cnc-token
        group: export
        value: ${data.token}
      description: export token
      nodeStep: false
      type: export-var
    - configuration:
        export: cnc-vip
        group: export
        value: ${data.mgt-vip*}
      description: export vip
      nodeStep: false
      type: export-var
    keepgoing: false
    strategy: node-first
  uuid: dc1ad0cc-965d-4d8a-a1a7-fd04a3553cc2

