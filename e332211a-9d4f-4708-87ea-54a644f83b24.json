[ {
  "defaultTab" : "nodes",
  "description" : "",
  "executionEnabled" : true,
  "group" : "CWC",
  "id" : "e332211a-9d4f-4708-87ea-54a644f83b24",
  "loglevel" : "INFO",
  "name" : "Get BGP Updates",
  "nodeFilterEditable" : false,
  "options" : [ {
    "enforced" : true,
    "name" : "ASN",
    "valuesUrl" : "file:/opt/cw/options/cwc-asn.json"
  }, {
    "dateFormat" : "YYYY-MM-DDTHH:mm:ssZ",
    "isDate" : true,
    "label" : "Start Date time",
    "name" : "fromdttm",
    "required" : true
  }, {
    "dateFormat" : "YYYY-MM-DDTHH:mm:ssZ",
    "isDate" : true,
    "label" : "To Date time",
    "name" : "todttm",
    "required" : true
  }, {
    "enforced" : true,
    "label" : "Alarm state filter",
    "name" : "state",
    "required" : true,
    "value" : "ADD",
    "values" : [ "ADD", "DELETE", "NONE" ],
    "valuesListDelimiter" : ","
  }, {
    "hidden" : true,
    "name" : "token",
    "required" : true,
    "secure" : true,
    "storagePath" : "keys/CWC/token",
    "valueExposed" : true
  } ],
  "plugins" : {
    "ExecutionLifecycle" : null
  },
  "scheduleEnabled" : true,
  "sequence" : {
    "commands" : [ {
      "description" : "determine filter",
      "plugins" : {
        "LogFilter" : [ {
          "config" : {
            "captureMultipleKeysValues" : "true",
            "hideOutput" : "false",
            "logData" : "true",
            "regex" : "^(.+?)\\s*=\\s*(.+)"
          },
          "type" : "key-value-data-multilines"
        } ]
      },
      "script" : "if [ \"@option.state@\" == \"ADD\" ]\nthen \n    echo filter=\"&updateType=BGP_UPDATE_ADD\"\n    echo dofilter=yes\nelif [ \"@option.state@\" == \"DELETE\" ]\nthen \n    echo filter=\"&updateType=BGP_UPDATE_DEL\"\n    echo dofilter=yes\nelif [ \"@option.state@\" == \"NONE\" ]\nthen \n    echo dofilter=no\n    echo filter=\nfi"
    }, {
      "description" : "date math",
      "plugins" : {
        "LogFilter" : [ {
          "config" : {
            "captureMultipleKeysValues" : "true",
            "hideOutput" : "false",
            "logData" : "true",
            "regex" : "^(.+?)\\s*=\\s*(.+)"
          },
          "type" : "key-value-data-multilines"
        } ]
      },
      "script" : "echo \"@option.fromdttm@\" | jq --raw-input --raw-output '[\"fromdate\",(split(\"+\") | (.[0]+\"Z\"|fromdateiso8601) as $iso | (.[1]|split(\":\") | (.[0]|tonumber*3600) + (.[1]|tonumber*3600/60)) as $offset | ($iso-$offset)|todateiso8601|tostring)]|join(\"=\")'\necho \"@option.todttm@\" | jq --raw-input --raw-output '[\"todate\",(split(\"+\") | (.[0]+\"Z\"|fromdateiso8601) as $iso | (.[1]|split(\":\") | (.[0]|tonumber*3600) + (.[1]|tonumber*3600/60)) as $offset | ($iso-$offset)|todateiso8601|tostring)]|join(\"=\")'"
    }, {
      "configuration" : {
        "authentication" : "None",
        "checkResponseCode" : "false",
        "file" : "/opt/cw/tmp/${job.execid}-cwc-asn.json",
        "headers" : " {\"Content-Type\": \"application/json\",\"Authorization\": \"Bearer ${option.token}\"}",
        "method" : "GET",
        "printResponse" : "true",
        "printResponseToFile" : "true",
        "proxySettings" : "false",
        "remoteUrl" : "https://crosswork.cisco.com/api/v1/asns",
        "sslVerify" : "true",
        "timeout" : "30000"
      },
      "description" : "Get ASNs",
      "nodeStep" : false,
      "type" : "edu.ohio.ais.rundeck.HttpWorkflowStepPlugin"
    }, {
      "description" : "create ASN",
      "script" : "filein=/opt/cw/tmp/@job.execid@-cwc-asn.json\nfileout=/opt/cw/options/cwc-asn.json\njq '[..|objects|select(has(\"asn\")).asn|tostring]' $filein > $fileout\n\n"
    }, {
      "exec" : "echo 'https://crosswork.cisco.com/api/v1/asns/${option.ASN}/bgp-updates?startTime=${data.fromdate*}&endTime=${data.todate*}${data.filter*}&sort=SORT_DESCENDING'"
    }, {
      "configuration" : {
        "authentication" : "None",
        "checkResponseCode" : "false",
        "file" : "/opt/cw/tmp/${job.execid}-cwc-bgpupdates.json",
        "headers" : " {\"Content-Type\": \"application/json\",\"Authorization\": \"Bearer ${option.token}\"}",
        "method" : "GET",
        "printResponse" : "false",
        "printResponseToFile" : "true",
        "proxySettings" : "false",
        "remoteUrl" : "https://crosswork.cisco.com/api/v1/asns/${option.ASN}/bgp-updates?startTime=${data.fromdate*}&endTime=${data.todate*}${data.filter*}&sort=SORT_DESCENDING",
        "sslVerify" : "true",
        "timeout" : "30000"
      },
      "description" : "Get",
      "nodeStep" : false,
      "type" : "edu.ohio.ais.rundeck.HttpWorkflowStepPlugin"
    }, {
      "description" : "parse response",
      "script" : "filein=/opt/cw/tmp/@job.execid@-cwc-bgpupdates.json\nfileout=/opt/cw/tmp/@job.execid@-cwc-bgpupdates.csv\necho using file : $filein\n\nTZ=Australia/Sydney\n\njq -r '{\"updates\":[.updates[] | (.updateAt|sub(\"(?<time>.*)\\\\.[\\\\d]{2,3}(?<tz>.*)\"; \"\\(.time)\\(.tz)\")) as $pre | .date=($pre|fromdateiso8601 | tonumber|strflocaltime((\"%d/%m/%Y\"))) | .time=($pre|fromdateiso8601 | tonumber|strflocaltime((\"%H:%M:%S\")))| .dttm=($pre|fromdateiso8601 | tonumber|strflocaltime((\"%d/%m/%Y\")))+ \" \"+($pre|fromdateiso8601 | tonumber|strflocaltime((\"%H:%M:%S\"))) ]}|[.updates[] |del(..|objects|select(has(\"allViolationPeers\")))|(..|select(has(\"updateAt\"))?).updateAt|=(fromdateiso8601 | tonumber|strflocaltime(\"%Y-%m-%d %H:%M:%S\"))|[ [leaf_paths as $path | {\"key\": $path | join(\"_\"), \"value\": getpath($path)}] | from_entries ] []] |  (.[0] | keys_unsorted) as $keys |   ([$keys] + map([.[ $keys[] ]])) [] | @csv' $filein 2>&1 | tee $fileout \n "
    } ],
    "keepgoing" : false,
    "strategy" : "node-first"
  },
  "uuid" : "e332211a-9d4f-4708-87ea-54a644f83b24"
} ]
