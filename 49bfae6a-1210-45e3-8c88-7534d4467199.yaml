- defaultTab: nodes
  description: |-
    Locates all the relevant infrastructure paths within the connected vCenter or ESX environment
    ---
    ## Requirements
    ### Credentials
    * `keys/vmware/vc-address` - FQDN or IP address of the vCenter server
    * `keys/vmware/vc-user` - User associated with `vc-address`
    * `keys/vmware/vc-password` - Password for vCenter user account
    ### Tooling
    * `govc` command line tool


    ## Functionality
    ```
    - use `govc` to discover all hosts, datastores and networks within the vCenter environment
    - store these as JSON files, to be used as inputs into other services such as provisioning
    ```
  executionEnabled: true
  group: CNC/Setup
  id: 49bfae6a-1210-45e3-8c88-7534d4467199
  loglevel: INFO
  name: Discovery vCenter Paths [ BHP ]
  nodeFilterEditable: false
  options:
  - enforced: true
    label: vCenter Server
    name: scope
    required: true
    value: home
    values:
    - home
    - dcloud
    - bhp
    valuesListDelimiter: ','
  - enforced: true
    label: VMware Type
    name: type
    required: true
    value: vc
    values:
    - esx
    - vc
    valuesListDelimiter: ','
  - label: Output Directory
    name: outputDir
    required: true
    value: /tmp
  - enforced: true
    hidden: true
    name: path
    required: true
    value: /backup/keys/keys/vmware
    values:
    - /backup/keys/keys/vmware
    valuesListDelimiter: ','
  plugins:
    ExecutionLifecycle: null
  scheduleEnabled: true
  sequence:
    commands:
    - description: GOVC variables
      plugins:
        LogFilter:
        - config:
            captureMultipleKeysValues: 'true'
            hideOutput: 'false'
            logData: 'true'
            regex: ^(.+?)\s*=\s*(.+)
          type: key-value-data-multilines
      script: |-
        echo GOVC_URL=$(cat @option.path@/vc-address-@option.scope@)
        echo GOVC_USERNAME=$(cat @option.path@/vc-user-@option.scope@)
        echo GOVC_PASSWORD=$(cat @option.path@/vc-password-@option.scope@)
        echo GOVC_INSECURE=1
    - description: Create files
      script: |-
        export GOVC_URL=@data.GOVC_URL*@
        export GOVC_USERNAME=@data.GOVC_USERNAME*@
        export GOVC_PASSWORD=@data.GOVC_PASSWORD*@
        export GOVC_INSECURE=@data.GOVC_INSECURE*@
        env | grep -i GOVC

        govc find -k -json -type h > @option.outputDir@/hosts-@option.scope@.json
        govc find -k -json -type d > @option.outputDir@/dcs-@option.scope@.json
        govc find -k -json -type s > @option.outputDir@/datastores-@option.scope@.json
        govc find -k -json -type n > @option.outputDir@/networks-@option.scope@.json

        echo @option.type@ >  @option.outputDir@/@option.scope@-vmwaretype.json
    keepgoing: false
    strategy: node-first
  uuid: 49bfae6a-1210-45e3-8c88-7534d4467199

