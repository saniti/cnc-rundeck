- defaultTab: nodes
  description: |+
    Deploys stored template services and policies from git. VPN services will be prefixed with the customer name

  executionEnabled: true
  group: -DEMO/Slicing
  id: b6daad5d-44a6-4487-8a4e-e2b6466ef929
  loglevel: INFO
  name: 2.0 - Create dedicated slice
  nodeFilterEditable: false
  notification:
    onsuccess:
      email:
        recipients: autoamtion@microlab.dcloud.cisco.com
        subject: '${notification.eventStatus} :[${job.name}]: New VPN Definition :
          ${option.customer}-${option.vpn-name}.json'
  notifyAvgDurationThreshold: null
  options:
  - hidden: true
    name: git
    required: true
    secure: true
    storagePath: keys/git/repo
    valueExposed: true
  - hidden: true
    name: token
    required: true
    secure: true
    storagePath: keys/gitea/token
    valueExposed: true
  - description: |-
      > [Authenticate](96e872a2-5704-4af6-96dc-47758e6049d9)
      ## CW/NSO Commit Options
    enforced: true
    label: CNC POD
    name: cnc-pod
    required: true
    valuesUrl: file:/opt/cw/options/cw-environments.json
  - description: '## git options'
    enforced: true
    label: Commit Options
    name: dry-run-options
    required: true
    valuesUrl: file:/opt/cw/options/nso-commit-options.json
  - enforced: true
    label: Sync
    name: sync-option
    required: true
    value: 'true'
    values:
    - 'true'
    - 'false'
    valuesListDelimiter: ','
  - enforced: true
    label: git owner
    name: git-owners
    required: true
    value: dcloud
    valuesUrl: http://${option.proxy.value}/git/owners
  - enforced: true
    label: git repository
    name: git-repos
    required: true
    value: slice-data
    valuesUrl: http://${option.proxy.value}/git/myrepos/${option.git-owners.value}
  - enforced: true
    label: GIT Branch
    name: git-branch
    required: true
    valuesUrl: http://${option.proxy.value}/git/branches/${option.git-owners.value}/${option.git-repos.value}
  - enforced: true
    label: Repo directories
    name: git-dirs
    required: true
    value: slice-demo
    valuesUrl: http://${option.proxy.value}/git/content/dir/${option.git-owners.value}/${option.git-repos.value}/${option.git-branch.value}
  - description: '## Slice Details'
    enforced: true
    label: slice
    name: slice
    required: true
    sortValues: true
    valuesUrl: http://${option.proxy.value}/git/files/${option.git-owners.value}/${option.git-repos.value}/${option.git-branch.value}/${option.git-dirs.value}
  - enforced: true
    label: Slice Type
    name: slice-type
    required: true
    value: eMBB
    values:
    - eMBB
    - URLLC
    - QoS_Tests
    valuesListDelimiter: ','
  - label: VLAN
    name: vlan
    required: true
  - description: |
      > [Add](8e3b0a1a-421c-4d0d-bb2c-c7d0af07116c)|[Remove](eec83222-22a5-46b9-9712-0b869442c27d)
    enforced: true
    label: Customer
    name: service-customer
    required: true
    valuesUrl: file:/opt/cw/options/customers.json
  - label: Service identifier
    name: service-id
    required: true
  - description: '## Node 1 details'
    label: Service description
    name: service-descr
    required: true
  - enforced: true
    label: Node 1
    name: device-1
    required: true
    value: Node-5
    valuesUrl: http://${option.proxy.value}/devices
  - enforced: true
    label: Interface on node 1
    name: device-1-interface
    required: true
    value: GigabitEthernet0/0/0/1
    valuesUrl: http://${option.proxy.value}/interfaces/${option.device-1.value}
  - description: '## Node 2 details'
    label: IP for interface
    name: device-1-interface-ip
    required: true
    value: 30.1.1.1
  - enforced: true
    label: Node 2
    name: device-2
    required: true
    value: Node-4
    valuesUrl: http://${option.proxy.value}/devices
  - enforced: true
    label: Interface on node 2
    name: device-2-interface
    required: true
    value: GigabitEthernet0/0/0/1
    valuesUrl: http://${option.proxy.value}/interfaces/${option.device-2.value}
  - description: '## Node 3 details'
    label: IP for interface
    name: device-2-interface-ip
    required: true
    value: 30.1.2.1
  - enforced: true
    label: Node 3
    name: device-3
    required: true
    value: Node-3
    valuesUrl: http://${option.proxy.value}/devices
  - enforced: true
    label: Interface on node 3
    name: device-3-interface
    required: true
    value: GigabitEthernet0/0/0/1
    valuesUrl: http://${option.proxy.value}/interfaces/${option.device-3.value}
  - label: IP for interface
    name: device-3-interface-ip
    required: true
    value: 30.1.3.1
  - hidden: true
    name: now
    required: true
    value: ${DATE:yyyy-MM-dd-HH-mm-ss}
  - enforced: true
    hidden: true
    name: proxy
    required: true
    value: proxy:3001
    values:
    - proxy:3001
    valuesListDelimiter: ','
  plugins:
    ExecutionLifecycle: null
  scheduleEnabled: true
  sequence:
    commands:
    - description: Dry run options
      plugins:
        LogFilter:
        - config:
            captureMultipleKeysValues: 'true'
            hideOutput: 'false'
            logData: 'true'
            regex: ^(.+?)\s*=\s*(.+)
          type: key-value-data-multilines
      script: "if [ \"@option.dry-run-options@\" = \"commit\" ]\nthen\n    echo DRY_RUN_COMMAND=\"\
        ?async-commit-queue=@option.sync-option@\"\n    echo RUN_EXPORT=false    \n\
        else\n    echo DRY_RUN_COMMAND=\"@option.dry-run-options@\"\n    echo RUN_EXPORT=true\n\
        fi"
    - configuration:
        authentication: None
        checkResponseCode: 'true'
        file: /opt/cw/tmp/${job.execid}-blob-slice.json
        headers: |
          {"accept": "application/json","Authorization":"Bearer ${option.token}"}
        method: GET
        printResponse: 'true'
        printResponseToFile: 'true'
        proxySettings: 'false'
        remoteUrl: ${option.slice}
        responseCode: '200'
        sslVerify: 'false'
        timeout: '30000'
      description: get slice-template
      nodeStep: false
      plugins:
        LogFilter:
        - config:
            captureMultipleKeysValues: 'true'
            hideOutput: 'false'
            logData: 'true'
            regex: ^(.+?)\s*=\s*(.+)
          type: key-value-data-multilines
      type: edu.ohio.ais.rundeck.HttpWorkflowStepPlugin
    - description: get names
      plugins:
        LogFilter:
        - config:
            captureMultipleKeysValues: 'true'
            hideOutput: 'false'
            logData: 'true'
            regex: ^(.+?)\s*=\s*(.+)
          type: key-value-data-multilines
      script: |-
        slice=/opt/cw/tmp/@job.execid@-blob-slice.json
        jq -r '"slice-file="+(.name|tostring)' $slice
    - configuration:
        authentication: None
        checkResponseCode: 'true'
        file: /opt/cw/tmp/${job.execid}-slice.json
        headers: |
          {"accept": "application/json","Authorization":"Bearer ${option.token}"}
        method: GET
        printResponse: 'true'
        printResponseToFile: 'true'
        proxySettings: 'false'
        remoteUrl: ${option.git}/api/v1/repos/${option.git-owners}/${option.git-repos}/raw/${option.git-dirs}/${data.slice-file*}?ref=${option.git-branch}
        responseCode: '200'
        sslVerify: 'false'
        timeout: '30000'
      description: get sliceas JSON
      nodeStep: false
      type: edu.ohio.ais.rundeck.HttpWorkflowStepPlugin
    - description: update
      plugins:
        LogFilter:
        - config:
            invalidKeyPattern: \s|\$|\{|\}|\\
            logData: 'true'
            name: slice-payload
            regex: (.*)
            replaceFilteredResult: 'false'
          type: key-value-data
      script: |+
        file=/opt/cw/tmp/@job.execid@-slice.json
        res=$(jq -c '(..|select("slice-service"?)."slice-service"[]."service-id") |="@option.service-id@"' $file)
        res=$(echo $res | jq -c '(..|select("slice-service"?)."slice-service"[]."service-description") |="@option.service-descr@"' )
        res=$(echo $res | jq -c '(.. |select(type == "object" and ."tag-type"?==("ietf-network-slice-service:service-tag-customer")).value[]) |="@option.service-customer@"' )
        res=$(echo $res | jq -c '(..|select("slice-service"?)."slice-service"[]."slo-sle-template") |="@option.slice-type@"' )

        # device 1
        res=$(echo $res | jq -c '(.. |select(type == "object" and ."sdp-id"?==("1"))."node-id")|="@option.device-1@"' )
        res=$(echo $res | jq -c '(.. |select(type == "object" and ."sdp-id"?==("1"))."attachment-circuits"."attachment-circuit"[]."ac-tp-id")|="@option.device-1-interface@"' )
        res=$(echo $res | jq -c '(.. |select(type == "object" and ."sdp-id"?==("1"))."attachment-circuits"."attachment-circuit"[]."ac-ip-address")|="@option.device-1-interface-ip@"
        ' )
        res=$(echo $res | jq -c '(.. |select(type == "object" and ."sdp-id"?==("1"))."attachment-circuits"."attachment-circuit"[]."ac-tags"."ac-tags"[].value[])|=@option.vlan@
        ' )

        # device 2
        res=$(echo $res | jq -c '(.. |select(type == "object" and ."sdp-id"?==("2"))."node-id")|="@option.device-2@"' )
        res=$(echo $res | jq -c '(.. |select(type == "object" and ."sdp-id"?==("2"))."attachment-circuits"."attachment-circuit"[]."ac-tp-id")|="@option.device-2-interface@"' )
        res=$(echo $res | jq -c '(.. |select(type == "object" and ."sdp-id"?==("2"))."attachment-circuits"."attachment-circuit"[]."ac-ip-address")|="@option.device-2-interface-ip@"
        ' )
        res=$(echo $res | jq -c '(.. |select(type == "object" and ."sdp-id"?==("2"))."attachment-circuits"."attachment-circuit"[]."ac-tags"."ac-tags"[].value[])|=@option.vlan@
        ' )

        # device 2
        res=$(echo $res | jq -c '(.. |select(type == "object" and ."sdp-id"?==("3"))."node-id")|="@option.device-3@"' )
        res=$(echo $res | jq -c '(.. |select(type == "object" and ."sdp-id"?==("3"))."attachment-circuits"."attachment-circuit"[]."ac-tp-id")|="@option.device-3-interface@"' )
        res=$(echo $res | jq -c '(.. |select(type == "object" and ."sdp-id"?==("3"))."attachment-circuits"."attachment-circuit"[]."ac-ip-address")|="@option.device-3-interface-ip@"
        ' )
        res=$(echo $res | jq -c '(.. |select(type == "object" and ."sdp-id"?==("3"))."attachment-circuits"."attachment-circuit"[]."ac-tags"."ac-tags"[].value[])|=@option.vlan@
        ' )

        echo $res | jq -c .


    - jobref:
        group: CNC/Configuration
        importOptions: true
        name: get key vars
        project: CNC
        uuid: c3b0db66-3fdd-49b7-a5b5-4261a0ff3463
    - configuration:
        authentication: None
        body: ${data.slice-payload*}
        checkResponseCode: 'false'
        headers: '{''Authorization'': ''Bearer ${export.cwtoken}'',''Content-Type'':
          ''application/yang-data+json''}'
        method: PATCH
        printResponse: 'true'
        printResponseToFile: 'false'
        proxySettings: 'false'
        remoteUrl: https://${export.cwvip}:30603/crosswork/proxy/nso/restconf/data${data.DRY_RUN_COMMAND*}
        sslVerify: 'false'
        timeout: '3000000'
      description: Create Service slice-payload
      nodeStep: false
      plugins:
        LogFilter:
        - config:
            datatype: application/json
            sanitizeHtml: 'true'
            striped: 'true'
          type: render-datatype
      type: edu.ohio.ais.rundeck.HttpWorkflowStepPlugin
    - configuration:
        fail: 'false'
        halt: 'true'
      description: success
      nodeStep: false
      type: flow-control
    keepgoing: false
    strategy: node-first
  uuid: b6daad5d-44a6-4487-8a4e-e2b6466ef929

