[ {
  "defaultTab" : "nodes",
  "description" : "CNC Patch Uploader\n\n# Overview\nThis will allow the user to choose a patch file from the list for CNC, and the script will upload it to CNC ready for installation.\n",
  "executionEnabled" : false,
  "group" : "CNC/Update",
  "id" : "db02ad7c-528f-49ee-95fe-0ef7006316f9",
  "loglevel" : "INFO",
  "name" : "CNC-01 - App Updates",
  "nodeFilterEditable" : true,
  "nodefilters" : {
    "dispatch" : {
      "excludePrecedence" : true,
      "keepgoing" : false,
      "rankOrder" : "ascending",
      "successOnEmptyNodeFilter" : false,
      "threadcount" : "1"
    },
    "filter" : "name: 10.66.182.68 "
  },
  "nodesSelectedByDefault" : true,
  "options" : [ {
    "enforced" : true,
    "name" : "patch-release",
    "required" : true,
    "value" : "3.0.1",
    "valuesUrl" : "file:/opt/cw/options/cw-packages-choice.json"
  }, {
    "delimiter" : ",",
    "description" : "Allowed file that can be uploaded to crosswork, used for patching and upgrades.",
    "enforced" : true,
    "label" : "File to Upload",
    "multivalueAllSelected" : true,
    "multivalued" : true,
    "name" : "app-file",
    "required" : true,
    "valuesUrl" : "file:/opt/cw/options/cw-packages-updates-${option.patch-release.value}.json"
  }, {
    "hidden" : true,
    "name" : "remote_ssh_pass",
    "required" : true,
    "secure" : true,
    "storagePath" : "keys/useraccounts/siprice",
    "valueExposed" : true
  }, {
    "hidden" : true,
    "name" : "remote_ssh_user",
    "required" : true,
    "secure" : true,
    "storagePath" : "keys/useraccounts/jumphost-user-siprice",
    "valueExposed" : true
  }, {
    "enforced" : true,
    "label" : "VIP for CNC",
    "name" : "cnc-vip",
    "required" : true,
    "value" : "192.168.226.xxx",
    "valuesUrl" : "file:/opt/cw/options/cw-environments.json"
  }, {
    "hidden" : true,
    "name" : "cw-admin-password",
    "required" : true,
    "secure" : true,
    "storagePath" : "keys/cw/cw-admin",
    "valueExposed" : true
  }, {
    "hidden" : true,
    "name" : "cw-port",
    "required" : true,
    "value" : "30603"
  } ],
  "plugins" : {
    "ExecutionLifecycle" : null
  },
  "scheduleEnabled" : true,
  "sequence" : {
    "commands" : [ {
      "description" : "get images",
      "exec" : "ls -latrh /opt/cw/patches/${option.patch-release}/*.gz"
    }, {
      "configuration" : {
        "command" : "curl -k --location --request POST 'https://${option.cnc-vip}:${option.cw-port}/crosswork/sso/v1/tickets?username=admin&password=${option.cw-admin-password}'  --header 'Content-Type: application/x-www-form-urlencoded'  --header 'Accept: text/plain'  --header 'Cache-Control: no-cache' --data-raw ''"
      },
      "description" : "Get-TICKET",
      "nodeStep" : true,
      "plugins" : {
        "LogFilter" : [ {
          "config" : {
            "invalidKeyPattern" : "\\s|\\$|\\{|\\}|\\\\",
            "logData" : "true",
            "name" : "TICKET",
            "regex" : "(.*)"
          },
          "type" : "key-value-data"
        } ]
      },
      "type" : "localexec"
    }, {
      "configuration" : {
        "command" : "curl -k --location --request POST 'https://${option.cnc-vip}:${option.cw-port}/crosswork/sso/v1/tickets/${data.TICKET}' --header 'Content-Type: application/x-www-form-urlencoded' --header 'Accept: text/plain' --header 'Cache-Control: no-cache' --data-urlencode 'service=https://198.18.134.219:30603/app-dashboard'"
      },
      "description" : "Get TOKEN",
      "nodeStep" : true,
      "plugins" : {
        "LogFilter" : [ {
          "config" : {
            "invalidKeyPattern" : "\\s|\\$|\\{|\\}|\\\\",
            "logData" : "true",
            "name" : "TOKEN",
            "regex" : "(.*)"
          },
          "type" : "key-value-data"
        } ]
      },
      "type" : "localexec"
    }, {
      "description" : "flatten input files",
      "plugins" : {
        "LogFilter" : [ {
          "config" : {
            "invalidKeyPattern" : "\\s|\\$|\\{|\\}|\\\\",
            "logData" : "true",
            "name" : "file-list",
            "regex" : "(.*)"
          },
          "type" : "key-value-data"
        } ]
      },
      "script" : "echo @option.app-file@ | tr \",\" \" \""
    }, {
      "script" : "#for i in `echo @data.file-list*@`; do echo curl -k --location --request POST 'https://@option.cnc-vip@:@option.cw-port@/crosswork/platform/v2/capp/repository/packagedata' --header 'Content-Type: application/x-www-form-urlencoded' --header 'Accept: text/plain' --header 'Cache-Control: no-cache' --header 'Authorization: Bearer @data.TOKEN@' --data-raw {\"remote_file\":\"/opt/cw/install/$i\",\"ssh_config\":{\"remote_host\":\"10.66.182.68\",\"username\":\"@option.remote_ssh_user@\",\"password\":\"@option.remote_ssh_pass@\",\"port\":22}}; done\n#for i in `echo $@data.file-list*@`; do curl -k --location --request POST https://@option.cnc-vip@:@option.cw-port@/crosswork/platform/v2/capp/repository/packagedata --header 'Content-Type: application/x-www-form-urlencoded' --header 'Accept: text/plain' --header 'Cache-Control: no-cache' --header 'Authorization: Bearer @data.token*@' --data-raw '{\"remote_file\":\"/opt/cw/install/$i\",\"ssh_config\":{\"remote_host\":\"10.66.182.68\",\"username\":\"@option.remote_ssh_user@\",\"password\":\"@option.remote_ssh_pass@\",\"port\":22}}'; done\n\nfor i in `echo @data.file-list*@`; do eval $(echo curl -k --location --request POST https://@option.cnc-vip@:@option.cw-port@/crosswork/platform/v2/capp/repository/packagedata --header \\'Content-Type: application/x-www-form-urlencoded\\' --header \\'Accept: text/plain\\' --header \\'Cache-Control: no-cache\\' --header \\'Authorization: Bearer @data.TOKEN*@\\' --data-raw \\'\\{\\\"remote_file\\\":\\\"/opt/cw/patches/@option.patch-release@/$i\\\",\\\"ssh_config\\\":\\{\\\"remote_host\\\":\\\"10.66.182.68\\\",\\\"username\\\":\\\"@option.remote_ssh_user@\\\",\\\"password\\\":\\\"@option.remote_ssh_pass@\\\",\\\"port\\\":22\\}\\}\\'); done\n\n\n"
    }, {
      "configuration" : {
        "command" : "curl -k --location --request POST 'https://${option.cnc-vip}:${option.cw-port}/crosswork/platform/v2/capp/applicationsummary/query' --header 'Content-Type: application/x-www-form-urlencoded' --header 'Accept: text/plain' --header 'Cache-Control: no-cache' --header 'Authorization: Bearer ${data.TOKEN}' --data-raw  '{}'"
      },
      "description" : "Get Product Versions",
      "nodeStep" : true,
      "type" : "localexec"
    }, {
      "configuration" : {
        "command" : "sleep 5"
      },
      "description" : "sleep",
      "nodeStep" : true,
      "type" : "localexec"
    }, {
      "configuration" : {
        "command" : "curl -k --location --request POST 'https://${option.cnc-vip}:${option.cw-port}/crosswork/platform/v2/capp/events/query' --header 'Content-Type: application/x-www-form-urlencoded' --header 'Accept: text/plain' --header 'Cache-Control: no-cache' --header 'Authorization: Bearer ${data.TOKEN}' --data-raw  '{\"event_tags\":[{\"tag_type\":\"JOB_ID_EVENT\",\"tag_value\":\"${data.jobid}\"}],\"query_options\":{\"pagination\":{\"page_size\":200}}}'"
      },
      "description" : "Get JOB Status",
      "nodeStep" : true,
      "plugins" : {
        "LogFilter" : [ {
          "config" : {
            "datatype" : "application/json",
            "sanitizeHtml" : "true",
            "striped" : "true"
          },
          "type" : "render-datatype"
        } ]
      },
      "type" : "localexec"
    }, {
      "configuration" : {
        "command" : "curl -k --location --request POST 'https://${option.cnc-vip}:${option.cw-port}/crosswork/platform/v2/capp/applicationsummary/query' --header 'Content-Type: application/x-www-form-urlencoded' --header 'Accept: text/plain' --header 'Cache-Control: no-cache' --header 'Authorization: Bearer ${data.TOKEN}' --data-raw  '{}'"
      },
      "description" : "Get Product Versions",
      "nodeStep" : true,
      "plugins" : {
        "LogFilter" : [ {
          "config" : {
            "invalidKeyPattern" : "\\s|\\$|\\{|\\}|\\\\",
            "logData" : "true",
            "name" : "test",
            "regex" : "((?:\"name\":\")(.*?)(?:\"))"
          },
          "type" : "key-value-data"
        }, {
          "config" : {
            "datatype" : "application/json",
            "sanitizeHtml" : "true",
            "striped" : "false"
          },
          "type" : "render-datatype"
        } ]
      },
      "type" : "localexec"
    }, {
      "configuration" : {
        "debugOnly" : "false"
      },
      "description" : "log data",
      "nodeStep" : false,
      "type" : "log-data-step"
    } ],
    "keepgoing" : false,
    "strategy" : "node-first"
  },
  "uuid" : "db02ad7c-528f-49ee-95fe-0ef7006316f9"
} ]
