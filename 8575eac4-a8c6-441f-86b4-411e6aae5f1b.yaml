- defaultTab: nodes
  description: ''
  executionEnabled: true
  group: -DEMO/.working
  id: 8575eac4-a8c6-441f-86b4-411e6aae5f1b
  loglevel: INFO
  name: CNC - KPI list
  nodeFilterEditable: false
  notification:
    onsuccess:
      email:
        recipients: device-details@necehealthpoc.local
        subject: ${notification.eventStatus} ${job.name}
  notifyAvgDurationThreshold: null
  options:
  - enforced: true
    label: CW POD
    name: cnc-pod
    required: true
    valuesUrl: file:/opt/cw/options/cw-environments.json
  plugins:
    ExecutionLifecycle: null
  scheduleEnabled: true
  sequence:
    commands:
    - jobref:
        group: CNC/Configuration
        importOptions: true
        name: get key vars
        uuid: c3b0db66-3fdd-49b7-a5b5-4261a0ff3463
    - configuration:
        debugOnly: 'false'
      nodeStep: false
      type: log-data-step
    - configuration:
        authentication: None
        body: '{}'
        checkResponseCode: 'false'
        file: /opt/cw/tmp/${job.execid}.json
        headers: |2+
           {"Content-Type": "application/json","Authorization": "Bearer ${export.cwtoken}"}

        method: POST
        printResponse: 'true'
        printResponseToFile: 'true'
        proxySettings: 'false'
        remoteUrl: https://${export.mgtvip}:30603/crosswork/hi/v1/kpimgmt/query
        sslVerify: 'false'
        timeout: '30000'
      description: get lsp data
      nodeStep: false
      type: edu.ohio.ais.rundeck.HttpWorkflowStepPlugin
    - description: get CSV
      script: |-
        file=/opt/cw/tmp/@job.execid@.json
        #jq -r '.lsps[]| [ keys[] as $k | .[$k] ]| @csv' $file

        jq -r '[.kpis[][] | del(.. | ."script"?)| del(.. | ."documentation"?)|(..|select(has("last_updation_date"))?)."last_updation_date"|=(.|tonumber/1000| gmtime| strflocaltime ("%Y-%m-%dT%H:%M:%SZ")) |(..|select(has("optimaLastUpdate"))?)."optimaLastUpdate"|=(./1000| gmtime| strflocaltime ("%Y-%m-%dT%H:%M:%SZ")) |(..|select(has("optimaPceComputedTime"))?)."optimaPceComputedTime"|=(.|tonumber| gmtime| strflocaltime ("%Y-%m-%dT%H:%M:%SZ")) | [ [leaf_paths as $path | {"key": $path | join("_"), "value": getpath($path)}] | from_entries ] []] |  (.[0] | keys_unsorted) as $keys |  ([$keys] + map([.[ $keys[] ]])) [] | @csv' $file
    keepgoing: false
    strategy: node-first
  uuid: 8575eac4-a8c6-441f-86b4-411e6aae5f1b

