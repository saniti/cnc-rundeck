[ {
  "defaultTab" : "nodes",
  "description" : "Allocates next available IP based on tag\n## Usage\n- Choose the network\n- View the last step to see which IP/Mask/Gateway was calculated\n## Features\n- Allocates next free IP from a prefix\n- Returns the IP, Subnet Mask and calculates gateway as '.1'\n## Valid Tags\n- cnc-mgmt\n- cnc-data\n- cnc-device\n## if Num\nThe `ifnum` field is used in parent workflow in order to distinguish each IP address",
  "executionEnabled" : true,
  "group" : "Netbox",
  "id" : "0ff19321-403f-42bd-9ac1-ed2a4507b496",
  "loglevel" : "INFO",
  "name" : "GET Next IP",
  "nodeFilterEditable" : false,
  "notification" : {
    "onsuccess" : {
      "email" : {
        "attachLog" : true,
        "attachLogInFile" : true,
        "recipients" : "siprice@cisco.com",
        "subject" : "${notification.eventStatus} ${job.name} : New IP for ${option.search_tag} [${export.ip}]"
      }
    }
  },
  "notifyAvgDurationThreshold" : null,
  "options" : [ {
    "enforced" : true,
    "name" : "search_tag",
    "required" : true,
    "value" : "cnc-mgt-vip",
    "values" : [ "cnc-mgt-vip", "cnc-data", "cnc-device", "cnc-mgmt" ],
    "valuesListDelimiter" : ","
  }, {
    "enforced" : true,
    "name" : "state",
    "value" : "reserved",
    "values" : [ "active", "reserved" ],
    "valuesListDelimiter" : ","
  }, {
    "name" : "description"
  }, {
    "hidden" : true,
    "label" : "Netbox Server",
    "name" : "netbox-server",
    "required" : true,
    "secure" : true,
    "storagePath" : "keys/netbox/netbox-host",
    "valueExposed" : true
  }, {
    "hidden" : true,
    "label" : "API Token",
    "name" : "api-token",
    "required" : true,
    "secure" : true,
    "storagePath" : "keys/netbox/netbox-token",
    "valueExposed" : true
  }, {
    "enforced" : true,
    "name" : "ClusterID",
    "required" : true,
    "value" : "1",
    "values" : [ "1", "2", "3", "4" ],
    "valuesListDelimiter" : ","
  }, {
    "name" : "ifnum",
    "required" : true,
    "value" : "1"
  } ],
  "plugins" : {
    "ExecutionLifecycle" : null
  },
  "scheduleEnabled" : true,
  "sequence" : {
    "commands" : [ {
      "configuration" : {
        "debugOnly" : "false"
      },
      "nodeStep" : false,
      "type" : "log-data-step"
    }, {
      "configuration" : {
        "authentication" : "None",
        "checkResponseCode" : "true",
        "file" : "/tmp/${job.execid}.json",
        "headers" : "{\"Content-Type\":\"application/json\",\"Authorization\":\"${option.api-token}\"}",
        "method" : "GET",
        "printResponse" : "true",
        "printResponseToFile" : "true",
        "proxySettings" : "false",
        "remoteUrl" : "${option.netbox-server}/ipam/vlan-groups?tag=customer&brief=1",
        "responseCode" : "200",
        "sslVerify" : "false",
        "timeout" : "30000"
      },
      "description" : "Get vlan groups",
      "nodeStep" : false,
      "type" : "edu.ohio.ais.rundeck.HttpWorkflowStepPlugin"
    }, {
      "configuration" : {
        "authentication" : "None",
        "body" : "[ { \"name\": \"t2est\",\"status\":\"reserved\" }]",
        "checkResponseCode" : "false",
        "file" : "/tmp/${job.execid}.json",
        "headers" : "{\"Content-Type\":\"application/json\",\"Authorization\":\"${option.api-token}\"}",
        "method" : "POST",
        "printResponse" : "true",
        "printResponseToFile" : "true",
        "proxySettings" : "false",
        "remoteUrl" : "${option.netbox-server}/ipam/vlan-groups/1/available-vlans/",
        "responseCode" : "200",
        "sslVerify" : "false",
        "timeout" : "30000"
      },
      "description" : "Get vlans",
      "nodeStep" : false,
      "type" : "edu.ohio.ais.rundeck.HttpWorkflowStepPlugin"
    }, {
      "configuration" : {
        "authentication" : "None",
        "checkResponseCode" : "true",
        "file" : "/tmp/${job.execid}.json",
        "headers" : "{\"Content-Type\":\"application/json\",\"Authorization\":\"${option.api-token}\"}",
        "method" : "GET",
        "printResponse" : "true",
        "printResponseToFile" : "true",
        "proxySettings" : "false",
        "remoteUrl" : "${option.netbox-server}/ipam/prefixes/?tag=${option.search_tag}&brief=1",
        "responseCode" : "200",
        "sslVerify" : "false",
        "timeout" : "30000"
      },
      "description" : "Get Prefix ID",
      "nodeStep" : false,
      "type" : "edu.ohio.ais.rundeck.HttpWorkflowStepPlugin"
    }, {
      "exec" : "jq \".results[].id\" /tmp/${job.execid}.json",
      "plugins" : {
        "LogFilter" : [ {
          "config" : {
            "invalidKeyPattern" : "\\s|\\$|\\{|\\}|\\\\",
            "logData" : "true",
            "name" : "prefix",
            "regex" : "(.*)"
          },
          "type" : "key-value-data"
        } ]
      }
    }, {
      "configuration" : {
        "authentication" : "None",
        "checkResponseCode" : "true",
        "file" : "/tmp/${job.execid}-ips.json",
        "headers" : "{\"Authorization\":\"${option.api-token}\",\"Accept\":\"*/*\"}",
        "method" : "POST",
        "printResponse" : "true",
        "printResponseToFile" : "true",
        "proxySettings" : "false",
        "remoteUrl" : "${option.netbox-server}/ipam/prefixes/${data.prefix*}/available-ips/",
        "responseCode" : "201",
        "sslVerify" : "false",
        "timeout" : "30000"
      },
      "description" : "Get Next IP",
      "nodeStep" : false,
      "type" : "edu.ohio.ais.rundeck.HttpWorkflowStepPlugin"
    }, {
      "exec" : "jq .address /tmp/${job.execid}-ips.json",
      "plugins" : {
        "LogFilter" : [ {
          "config" : {
            "invalidKeyPattern" : "\\s|\\$|\\{|\\}|\\\\",
            "logData" : "true",
            "name" : "snmask",
            "regex" : "\".*\\/(\\d+).*"
          },
          "type" : "key-value-data"
        }, {
          "config" : {
            "invalidKeyPattern" : "\\s|\\$|\\{|\\}|\\\\",
            "logData" : "true",
            "name" : "ip",
            "regex" : "\"(.*).*\\/[\\d+].*"
          },
          "type" : "key-value-data"
        }, {
          "config" : {
            "invalidKeyPattern" : "\\s|\\$|\\{|\\}|\\\\",
            "logData" : "true",
            "name" : "gateway",
            "regex" : "\"(\\d+.\\d+.\\d+).*"
          },
          "type" : "key-value-data"
        } ]
      }
    }, {
      "description" : "get ID",
      "exec" : "jq '.id' /tmp/${job.execid}-ips.json",
      "plugins" : {
        "LogFilter" : [ {
          "config" : {
            "invalidKeyPattern" : "\\s|\\$|\\{|\\}|\\\\",
            "logData" : "true",
            "name" : "id",
            "regex" : "(.*)"
          },
          "type" : "key-value-data"
        } ]
      }
    }, {
      "configuration" : {
        "authentication" : "None",
        "body" : "{\n    \"status\": \"${option.state}\",\n    \"description\" : \"${option.description}\" \n}",
        "checkResponseCode" : "true",
        "file" : "/tmp/${job.execid}-ips.json",
        "headers" : "{\"Authorization\":\"${option.api-token}\",\"Content-Type\":\"application/json\"}",
        "method" : "PATCH",
        "printResponse" : "true",
        "printResponseToFile" : "false",
        "proxySettings" : "false",
        "remoteUrl" : "${option.netbox-server}/ipam/ip-addresses/${data.id*}/",
        "responseCode" : "200",
        "sslVerify" : "false",
        "timeout" : "30000"
      },
      "description" : "Update IP Allocation",
      "nodeStep" : false,
      "type" : "edu.ohio.ais.rundeck.HttpWorkflowStepPlugin"
    }, {
      "description" : "Set GW",
      "exec" : "echo ${data.gateway}.1",
      "plugins" : {
        "LogFilter" : [ {
          "config" : {
            "invalidKeyPattern" : "\\s|\\$|\\{|\\}|\\\\",
            "logData" : "true",
            "name" : "gw",
            "regex" : "(.*)"
          },
          "type" : "key-value-data"
        } ]
      }
    }, {
      "configuration" : {
        "export" : "ip-${option.ifnum}",
        "group" : "export",
        "value" : "${data.ip*}"
      },
      "nodeStep" : false,
      "type" : "export-var"
    }, {
      "configuration" : {
        "export" : "mask-${option.ifnum}",
        "group" : "export",
        "value" : "${data.snmask*}"
      },
      "nodeStep" : false,
      "type" : "export-var"
    }, {
      "configuration" : {
        "export" : "ip",
        "group" : "export",
        "value" : "${data.ip*}"
      },
      "nodeStep" : false,
      "type" : "export-var"
    }, {
      "configuration" : {
        "export" : "gw-${option.ifnum}",
        "group" : "export",
        "value" : "${data.gw*}"
      },
      "nodeStep" : false,
      "type" : "export-var"
    }, {
      "configuration" : {
        "data" : "ip=${data.ip*}\nmask=${data.snmask*}\ngateway=${data.gw*}",
        "format" : "properties"
      },
      "description" : "IP Data",
      "nodeStep" : false,
      "plugins" : {
        "LogFilter" : [ {
          "config" : {
            "datatype" : "application/x-java-properties",
            "sanitizeHtml" : "true",
            "striped" : "true"
          },
          "type" : "render-datatype"
        } ]
      },
      "type" : "stub-data-step"
    } ],
    "keepgoing" : false,
    "strategy" : "sequential"
  },
  "uuid" : "0ff19321-403f-42bd-9ac1-ed2a4507b496"
} ]
