- defaultTab: nodes
  description: ''
  executionEnabled: true
  group: CNC/Configuration
  id: e0193a48-9284-4f4e-92de-9bab4d427e24
  loglevel: INFO
  name: CNC - Onboard Device (with CDG) v3
  nodeFilterEditable: false
  options:
  - enforced: true
    label: CNC POD
    name: cnc-vip
    required: true
    valuesUrl: file:/opt/cw/options/cw-environments.json
  - description: '> required'
    label: Device Name (short)
    name: device-name
    required: true
    valuesUrl: file:/opt/cw/options/${option.cnc-vip.value}-devices.json
  - description: '> required'
    label: Device IPv4 Address
    name: device-ip
    required: true
  - enforced: true
    label: Data Gateway Pool
    name: cdg
    required: true
    valuesUrl: file:/opt/cw/options/cdg.json
  - description: '> required'
    enforced: true
    name: location-data
    required: true
    valuesUrl: file:/opt/cw/options/locations.json
  - label: Device subnet mask
    name: device-mask
    required: true
    value: '32'
  - label: SSH Port
    name: device-ssh-port
    required: true
    value: '22'
  - label: SNMP Port
    name: device-snmp-port
    required: true
    value: '161'
  - description: '- optional'
    label: Telemetry VRF
    name: telemetry_intf_src_vrf
  - description: '- optional'
    label: Router ID
    name: te_router_id
  - hidden: true
    name: cnc-password
    required: true
    secure: true
    storagePath: keys/cw/admin
    valueExposed: true
  - hidden: true
    label: CNC User Name
    name: cnc-user
    required: true
    value: admin
  - description: This should be hidden
    hidden: true
    name: provider-schema
    value: '{"data":[{"node_ip":{"inet_af":"ROBOT_INET_ADDR_TYPE_v4","inet_addr":"0.0.0.0","mask":"32"},"host_name":"template","profile":"device_profile","reachability_state":"CONN_STATE_REACHABLE","admin_state":"ROBOT_ADMIN_STATE_UP","connectivity_info":[{"type":"ROBOT_MSVC_TRANS_SSH","ipaddrs":[{"inet_af":"ROBOT_INET_ADDR_TYPE_v4","inet_addr":"0.0.0.0","mask":"32"}],"port":22,"timeout":"120","reachability_state":"CONN_STATE_REACHABLE"},{"type":"ROBOT_MSVC_TRANS_SNMP","ipaddrs":[{"inet_af":"ROBOT_INET_ADDR_TYPE_v4","inet_addr":"0.0.0.0","mask":"32"}],"port":161,"timeout":"120","reachability_state":"CONN_STATE_REACHABLE"},{"type":"ROBOT_MSVC_TRANS_GNMI","ipaddrs":[{"inet_af":"ROBOT_INET_ADDR_TYPE_v4","inet_addr":"0.0.0.0","mask":"32"}],"port":57400,"timeout":"120","reachability_state":"CONN_STATE_REACHABLE","encoding_type":"PROTO"}],"geo_info":{"coordinates":{"longitude":{"value":149.8537},"latitude":{"value":-33.705}},"country":"Australia","range_incr":{}},"routing_info":{"telemetry_intf_src_vrf":"mgmt"},"reachability_check":"REACH_CHECK_ENABLE","providers_family":{"ROBOT_PROVIDER_NSO":{"providers":{"NSO_CNC":{"provider_name":"NSO_CNC","provider_node_id":"template"}}}}}]}'
  plugins:
    ExecutionLifecycle: null
  scheduleEnabled: true
  sequence:
    commands:
    - description: get device details
      jobref:
        args: -cnc-pod ${option.cnc-vip}
        group: CNC/Services
        importOptions: true
        name: CNC - Get Device Details
        uuid: 23d13185-8891-4031-9eea-580f733a346c
    - configuration:
        command: cat /opt/cw/tmp/${option.cnc-vip}.cwvip
      description: get vip
      nodeStep: true
      plugins:
        LogFilter:
        - config:
            invalidKeyPattern: \s|\$|\{|\}|\\
            logData: 'true'
            name: vip
            regex: (.*)
          type: key-value-data
      type: localexec
    - configuration:
        command: cat /opt/cw/tmp/${option.cnc-vip}.cwtoken
      description: get token
      nodeStep: true
      plugins:
        LogFilter:
        - config:
            invalidKeyPattern: \s|\$|\{|\}|\\
            logData: 'true'
            name: token
            regex: (.*)
          type: key-value-data
      type: localexec
    - configuration:
        command: jq '.[] | select(.name=="${option.location-data}")."Longitude"' /opt/cw/options/locations.json
      description: get long
      nodeStep: true
      plugins:
        LogFilter:
        - config:
            invalidKeyPattern: \s|\$|\{|\}|\\
            logData: 'true'
            name: longitude
            regex: (.*)
          type: key-value-data
      type: localexec
    - configuration:
        command: jq '.[] | select(.name=="${option.location-data}")."Latitude"' /opt/cw/options/locations.json
      description: get lat
      nodeStep: true
      plugins:
        LogFilter:
        - config:
            invalidKeyPattern: \s|\$|\{|\}|\\
            logData: 'true'
            name: latitude
            regex: (.*)
          type: key-value-data
      type: localexec
    - configuration:
        command: jq '.[] | select(.name=="${option.location-data}")."Country"' /opt/cw/options/locations.json
      description: get country
      nodeStep: true
      plugins:
        LogFilter:
        - config:
            invalidKeyPattern: \s|\$|\{|\}|\\
            logData: 'true'
            name: country
            regex: '.([A-Z,a-z]+).+'
          type: key-value-data
      type: localexec
    - description: reconfigure JSON object
      plugins:
        LogFilter:
        - config:
            invalidKeyPattern: \s|\$|\{|\}|\\
            logData: 'true'
            name: payload
            regex: (.*)
          type: key-value-data
      script: |-
        file=/tmp/@job.execid@.json
        tmpfile=/tmp/@job.execid@.json.tmp

        echo '@option.provider-schema@' > $file
        jq '( .data[].geo_info.coordinates.longitude.value)|="@data.longitude*@"' $file > $tmpfile
        jq '( .data[].geo_info.coordinates.latitude.value)|="@data.latitude*@"' $tmpfile > $file
        jq '( .data[].geo_info.country)|="@data.country*@"' $file > $tmpfile
        jq '(..|objects|select(has("inet_addr")))."inet_addr"|= "@option.device-ip@"' $tmpfile > $file
        jq '(..|objects|select(has("host_name")))."host_name"|= "@option.device-name@"' $file > $tmpfile
        jq '(..|objects|select(has("mask")))."mask"|= "@option.device-mask@"' $tmpfile > $file
        jq '(..|objects|select(has("provider_node_id")))."provider_node_id"|= "@option.device-name@cpocsyd.local"' $file > $tmpfile
        jq '(..|objects|select(has("te_router_id")))."te_router_id"|= "@option.te_router_id@"' $tmpfile > $file
        jq '(..|objects|select(has("telemetry_intf_src_vrf")))."telemetry_intf_src_vrf"|= "@option.telemetry_intf_src_vrf@"' $file > $tmpfile
        jq '(..|objects|select(has("telemetry_intf_src_name")))."telemetry_intf_src_name"|= "@option.telemetry_intf_src_name@"' $tmpfile > $file
        jq '( .data[].connectivity_info[]|select(.type=="ROBOT_MSVC_TRANS_SNMP") ).port|="@option.device-snmp-port@"' $file > $tmpfile
        jq '( .data[].connectivity_info[]|select(.type=="ROBOT_MSVC_TRANS_SSH") ).port|="@option.device-ssh-port@"' $tmpfile > $file
        jq '.data[].uuid|="@export.device-uuid@"' $file > $tmpfile
        jq -c . $tmpfile
    - configuration:
        debugOnly: 'false'
      nodeStep: false
      type: log-data-step
    - configuration:
        fail: 'false'
        halt: 'false'
        status: fail now
      description: fail
      nodeStep: false
      type: flow-control
    - configuration:
        authentication: None
        body: ${data.payload*}
        checkResponseCode: 'true'
        headers: '{"Content-Type": "application/json","Authorization": "Bearer ${data.token*}"}'
        method: PUT
        printResponse: 'true'
        printResponseToFile: 'false'
        proxySettings: 'false'
        remoteUrl: https://${data.vip*}:30603/crosswork/inventory/v1/nodes
        responseCode: '200'
        sslVerify: 'false'
        timeout: '30000'
      description: add device
      nodeStep: false
      type: edu.ohio.ais.rundeck.HttpWorkflowStepPlugin
    - description: get device details
      jobref:
        args: -cnc-pod ${option.cnc-vip}
        group: CNC/Services
        importOptions: true
        name: CNC - Get Device Details
        uuid: 23d13185-8891-4031-9eea-580f733a346c
    - configuration:
        data: '{"dgDeviceMappings":[{"cdg_duuid":"${option.cdg}","device_uuid":["${export.device-uuid}"],"mapping_oper":"ADD_OPER"}]}'
        format: json
      description: create payload
      nodeStep: false
      plugins:
        LogFilter:
        - config:
            invalidKeyPattern: \s|\$|\{|\}|\\
            logData: 'true'
            name: payload
            regex: (.*)
          type: key-value-data
      type: stub-data-step
    - configuration:
        authentication: None
        body: ${data.payload}
        checkResponseCode: 'false'
        headers: '{"Content-Type": "application/json","Authorization": "Bearer ${data.token*}"}'
        method: PUT
        printResponse: 'true'
        printResponseToFile: 'false'
        proxySettings: 'false'
        remoteUrl: https://${data.vip*}:30603/crosswork/inventory/v1/dg/devicemapping
        sslVerify: 'false'
        timeout: '30000'
      description: add to CDG
      nodeStep: false
      type: edu.ohio.ais.rundeck.HttpWorkflowStepPlugin
    - configuration:
        authentication: None
        body: '{"filter":{"uuid":"${export.device-uuid}"}}'
        checkResponseCode: 'false'
        headers: '{"Content-Type": "application/json","Authorization": "Bearer ${data.token*}"}'
        method: POST
        printResponse: 'true'
        printResponseToFile: 'false'
        proxySettings: 'false'
        remoteUrl: https://${data.vip*}:30603/crosswork/inventory/v1/nso/fetch-ssh-keys
        sslVerify: 'false'
        timeout: '30000'
      description: fetch SSH keys
      nodeStep: false
      type: edu.ohio.ais.rundeck.HttpWorkflowStepPlugin
    - configuration:
        authentication: None
        body: '{"filter":{"uuid":"${export.device-uuid}"}}'
        checkResponseCode: 'false'
        headers: '{"Content-Type": "application/json","Authorization": "Bearer ${data.token*}"}'
        method: POST
        printResponse: 'true'
        printResponseToFile: 'false'
        proxySettings: 'false'
        remoteUrl: https://${data.vip*}:30603/crosswork/inventory/v1/nso/sync-from
        sslVerify: 'false'
        timeout: '30000'
      description: fetch SSH keys
      nodeStep: false
      type: edu.ohio.ais.rundeck.HttpWorkflowStepPlugin
    keepgoing: false
    strategy: node-first
  uuid: e0193a48-9284-4f4e-92de-9bab4d427e24

