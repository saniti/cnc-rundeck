[ {
  "defaultTab" : "nodes",
  "description" : "OVF Command line builder for Data Gateway deployment\n## Features\n- Create an OVF command line for deploying a single Data Gateway VM",
  "executionEnabled" : true,
  "group" : "CNC/Deploy/CDG",
  "id" : "288a4ffd-e44d-4d7b-b663-de65c6f351d0",
  "loglevel" : "INFO",
  "multipleExecutions" : true,
  "name" : "CDG - Single Node (1 vnic)",
  "nodeFilterEditable" : false,
  "options" : [ {
    "description" : "Execute command or just generate it.\n- Generate (default) Show the command line that needs to be run, but the user\n- Execute - Generate the command line and run it on the local system",
    "enforced" : true,
    "name" : "Option",
    "required" : true,
    "value" : "Execute",
    "values" : [ "Execute", "Generate" ],
    "valuesListDelimiter" : ","
  }, {
    "enforced" : true,
    "label" : "Crossworks VIP",
    "name" : "controller-ip",
    "required" : true,
    "valuesUrl" : "file:/opt/cw/options/cw-environments.json"
  }, {
    "enforced" : true,
    "label" : "CW Version",
    "name" : "cw-version",
    "required" : true,
    "valuesUrl" : "file:/opt/cw/options/cw-versions.json"
  }, {
    "enforced" : true,
    "label" : "Deployment Type",
    "name" : "deployment-option",
    "required" : true,
    "value" : "onpremise-extended",
    "values" : [ "onpremise-extended", "onpremise-standard", "onpremise-standard-plus" ],
    "valuesListDelimiter" : ","
  }, {
    "enforced" : true,
    "label" : "vCPU",
    "name" : "deploy-option-cpu",
    "required" : true,
    "valuesUrl" : "file:/opt/cw/options/${option.deployment-option.value}-cpu.json"
  }, {
    "enforced" : true,
    "label" : "Memory",
    "name" : "deploy-option-mem",
    "required" : true,
    "valuesUrl" : "file:/opt/cw/options/${option.deployment-option.value}-mem.json"
  }, {
    "enforced" : true,
    "label" : "Disk",
    "name" : "deploy-option-disk",
    "required" : true,
    "valuesUrl" : "file:/opt/cw/options/${option.deployment-option.value}-disk.json"
  }, {
    "delimiter" : ",",
    "multivalued" : true,
    "name" : "ovf-options",
    "required" : true,
    "valuesUrl" : "file:/opt/cw/options/ovf-deploy-options.json"
  }, {
    "label" : "OVF Extra Configuration Options",
    "name" : "ovf-extra-config",
    "required" : true,
    "value" : "default",
    "values" : [ "advanced", "default" ],
    "valuesListDelimiter" : ","
  }, {
    "delimiter" : ",",
    "enforced" : true,
    "multivalued" : true,
    "name" : "ovf-extra-config-options",
    "required" : true,
    "valuesUrl" : "file:/opt/cw/options/extra-config-options.${option.ovf-extra-config.value}.json"
  }, {
    "label" : "CDG hostname",
    "name" : "host-name-1",
    "value" : "cdg01"
  }, {
    "description" : "Role for Netbox",
    "enforced" : true,
    "name" : "vm-role",
    "required" : true,
    "value" : "2",
    "valuesUrl" : "file:/opt/cw/options/roles.json"
  }, {
    "label" : "Domain Name",
    "name" : "domain-name",
    "required" : true,
    "value" : "ntf.local",
    "valuesUrl" : "file:/opt/cw/options/domains.json"
  }, {
    "label" : "Description",
    "name" : "description",
    "required" : true,
    "value" : "Cisco Data Gateway Node"
  }, {
    "label" : "CDG Pool",
    "name" : "label",
    "value" : "Pool1"
  }, {
    "hidden" : true,
    "label" : "CDG hostname",
    "name" : "host-name",
    "required" : true,
    "value" : "${option.host-name-1}"
  }, {
    "label" : "Crossworks port",
    "name" : "controller-port",
    "required" : true,
    "value" : "30607"
  }, {
    "delimiter" : ",",
    "label" : "DNS Server",
    "multivalued" : true,
    "name" : "dns-server",
    "required" : true,
    "valuesUrl" : "file:/opt/cw/options/dns-servers.json"
  }, {
    "delimiter" : ",",
    "label" : "NTP Server",
    "multivalued" : true,
    "name" : "ntp-server",
    "required" : true,
    "valuesUrl" : "file:/opt/cw/options/ntp-servers.json"
  }, {
    "delimiter" : ",",
    "enforced" : true,
    "label" : "Virtual Networking Options",
    "multivalued" : true,
    "name" : "vnic-options",
    "required" : true,
    "value" : "1",
    "values" : [ "1", "2" ],
    "valuesListDelimiter" : ","
  }, {
    "label" : "VM Datastore",
    "name" : "datastore-1",
    "required" : true,
    "valuesUrl" : "file:/tmp/datastores.json"
  }, {
    "label" : "VMware ESX host",
    "name" : "vmware-esx-host",
    "required" : true,
    "valuesUrl" : "file:/tmp/hosts.json"
  }, {
    "enforced" : true,
    "hidden" : true,
    "label" : "Number of Network Adapters",
    "name" : "active-vnics",
    "value" : "1",
    "values" : [ "1", "2" ],
    "valuesListDelimiter" : ","
  }, {
    "label" : "First Network",
    "name" : "vnic-1-network",
    "value" : "/HX-cluster/network/vm-network-411",
    "valuesUrl" : "file:/tmp/networks.json"
  }, {
    "hidden" : true,
    "name" : "dg-admin-password",
    "required" : true,
    "secure" : true,
    "storagePath" : "keys/cw/dg-admin",
    "valueExposed" : true
  }, {
    "hidden" : true,
    "name" : "dg-oper-password",
    "required" : true,
    "secure" : true,
    "storagePath" : "keys/cw/dg-oper",
    "valueExposed" : true
  }, {
    "hidden" : true,
    "name" : "cnc-password",
    "required" : true,
    "secure" : true,
    "storagePath" : "keys/cw/cw-admin",
    "valueExposed" : true
  }, {
    "hidden" : true,
    "name" : "vcenter-host",
    "secure" : true,
    "storagePath" : "keys/vmware/vc-address",
    "valueExposed" : true
  }, {
    "hidden" : true,
    "name" : "vcenter-password",
    "required" : true,
    "secure" : true,
    "storagePath" : "keys/vmware/vc-password",
    "valueExposed" : true
  }, {
    "hidden" : true,
    "name" : "vcenter-username",
    "required" : true,
    "secure" : true,
    "storagePath" : "keys/vmware/vc-user",
    "valueExposed" : true
  }, {
    "description" : "***Dynamic*** - IP Addressing from Netbox\n***Static*** - IP Addressing entered by user",
    "enforced" : true,
    "label" : "Network Options for Management Network",
    "name" : "vnic-0-static",
    "required" : true,
    "value" : "static",
    "values" : [ "dynamic", "static" ],
    "valuesListDelimiter" : ","
  }, {
    "description" : "IP Address for Management Interface",
    "label" : "Management - IP",
    "name" : "vnic-0-ip",
    "required" : true
  }, {
    "description" : "Subnet Mask",
    "label" : "Management - Mask",
    "name" : "vnic-0-mask",
    "required" : true,
    "value" : "255.255.255.0"
  }, {
    "description" : "Gateway IP",
    "label" : "Management - Gateway",
    "name" : "vnic-0-gateway",
    "required" : true
  } ],
  "plugins" : {
    "ExecutionLifecycle" : null
  },
  "retry" : "3",
  "scheduleEnabled" : true,
  "sequence" : {
    "commands" : [ {
      "description" : "get pod details",
      "jobref" : {
        "args" : "-cnc-pod ${option.controller-ip}",
        "group" : "CNC/Configuration",
        "name" : "get cnc pod details",
        "uuid" : "0ea1cf89-2324-4106-a507-e934a732da8e"
      }
    }, {
      "description" : "get version properties",
      "jobref" : {
        "args" : "-cnc-version ${option.cw-version}",
        "group" : "CNC/Configuration",
        "name" : "get version properties",
        "uuid" : "a08c2fb8-746f-4d29-8806-c6564f8c8465"
      }
    }, {
      "configuration" : {
        "command" : "basename \"${option.datastore-1}\""
      },
      "description" : "generate datastore name",
      "nodeStep" : true,
      "plugins" : {
        "LogFilter" : [ {
          "config" : {
            "invalidKeyPattern" : "\\s|\\$|\\{|\\}|\\\\",
            "logData" : "true",
            "name" : "datastore-name",
            "regex" : "(.*)"
          },
          "type" : "key-value-data"
        } ]
      },
      "type" : "localexec"
    }, {
      "configuration" : {
        "command" : "echo ${option.host-name}"
      },
      "description" : "generate host name",
      "nodeStep" : true,
      "plugins" : {
        "LogFilter" : [ {
          "config" : {
            "invalidKeyPattern" : "\\s|\\$|\\{|\\}|\\\\",
            "logData" : "true",
            "name" : "host-name",
            "regex" : "(.*)"
          },
          "type" : "key-value-data"
        } ]
      },
      "type" : "localexec"
    }, {
      "configuration" : {
        "command" : "basename '${option.vnic-1-network}'"
      },
      "description" : "generate vnic1 network",
      "nodeStep" : true,
      "plugins" : {
        "LogFilter" : [ {
          "config" : {
            "invalidKeyPattern" : "\\s|\\$|\\{|\\}|\\\\",
            "logData" : "true",
            "name" : "vnic-1-network",
            "regex" : "(.*)"
          },
          "type" : "key-value-data"
        } ]
      },
      "type" : "localexec"
    }, {
      "configuration" : {
        "command" : "basename ${option.datastore-1}"
      },
      "description" : "datastore",
      "nodeStep" : true,
      "plugins" : {
        "LogFilter" : [ {
          "config" : {
            "invalidKeyPattern" : "\\s|\\$|\\{|\\}|\\\\",
            "logData" : "true",
            "name" : "datastore",
            "regex" : "(.*)"
          },
          "type" : "key-value-data"
        } ]
      },
      "type" : "localexec"
    }, {
      "configuration" : {
        "command" : "echo cw-admin@${export.mgtvip}:/home/cw-admin/controller.pem"
      },
      "description" : "generate Certchain",
      "nodeStep" : true,
      "plugins" : {
        "LogFilter" : [ {
          "config" : {
            "invalidKeyPattern" : "\\s|\\$|\\{|\\}|\\\\",
            "logData" : "true",
            "name" : "certchain",
            "regex" : "(.*)"
          },
          "type" : "key-value-data"
        } ]
      },
      "type" : "localexec"
    }, {
      "description" : "ovf-options",
      "plugins" : {
        "LogFilter" : [ {
          "config" : {
            "invalidKeyPattern" : "\\s|\\$|\\{|\\}|\\\\",
            "logData" : "true",
            "name" : "ovf-options",
            "regex" : "(.*)"
          },
          "type" : "key-value-data"
        } ]
      },
      "script" : "echo @option.ovf-options@ | tr \",\" \" \"\n"
    }, {
      "description" : "flatten ovf extra config",
      "plugins" : {
        "LogFilter" : [ {
          "config" : {
            "invalidKeyPattern" : "\\s|\\$|\\{|\\}|\\\\",
            "logData" : "true",
            "name" : "ovf-extra-config-init",
            "regex" : "(.*)"
          },
          "type" : "key-value-data"
        } ]
      },
      "script" : "echo @option.ovf-extra-config-options@ | tr \",\" \" \" | tr \"default\" \" \""
    }, {
      "description" : "flatten ntp servers",
      "plugins" : {
        "LogFilter" : [ {
          "config" : {
            "invalidKeyPattern" : "\\s|\\$|\\{|\\}|\\\\",
            "logData" : "true",
            "name" : "ntp-servers",
            "regex" : "(.*)"
          },
          "type" : "key-value-data"
        } ]
      },
      "script" : "echo @option.ntp-server@ | tr \",\" \" \""
    }, {
      "description" : "flatten dns servers",
      "plugins" : {
        "LogFilter" : [ {
          "config" : {
            "invalidKeyPattern" : "\\s|\\$|\\{|\\}|\\\\",
            "logData" : "true",
            "name" : "dns-servers",
            "regex" : "(.*)"
          },
          "type" : "key-value-data"
        } ]
      },
      "script" : "echo @option.dns-server@ | tr \",\" \" \""
    }, {
      "description" : "CPU",
      "plugins" : {
        "LogFilter" : [ {
          "config" : {
            "invalidKeyPattern" : "\\s|\\$|\\{|\\}|\\\\",
            "logData" : "true",
            "name" : "CPU",
            "regex" : ".*CPU.(\\d+).*"
          },
          "type" : "key-value-data"
        } ]
      },
      "script" : "echo @option.deploy-option-values@\n\n\n"
    }, {
      "description" : "MEM",
      "plugins" : {
        "LogFilter" : [ {
          "config" : {
            "invalidKeyPattern" : "\\s|\\$|\\{|\\}|\\\\",
            "logData" : "true",
            "name" : "RAM",
            "regex" : ".*RAM.(\\d+).*"
          },
          "type" : "key-value-data"
        } ]
      },
      "script" : "echo @option.deploy-option-values@\n"
    }, {
      "description" : "DISK",
      "plugins" : {
        "LogFilter" : [ {
          "config" : {
            "invalidKeyPattern" : "\\s|\\$|\\{|\\}|\\\\",
            "logData" : "true",
            "name" : "DISK",
            "regex" : ".*DISK.(\\d+).*"
          },
          "type" : "key-value-data"
        } ]
      },
      "script" : "echo @option.deploy-option-values@\n"
    }, {
      "configuration" : {
        "command" : "bash -c 'if [ \"${option.vnic-0-static}\" == \"static\" ]; then echo ${option.vnic-0-ip},${option.vnic-0-mask},${option.vnic-0-gateway}; else false; fi'"
      },
      "description" : "0",
      "errorhandler" : {
        "jobref" : {
          "args" : "-search_tag cnc-mgmt -ifnum 1 -state reserved -description ${data.host-name*}",
          "group" : "Netbox",
          "name" : "GET Next IP",
          "uuid" : "0ff19321-403f-42bd-9ac1-ed2a4507b496"
        },
        "keepgoingOnSuccess" : true
      },
      "nodeStep" : true,
      "plugins" : {
        "LogFilter" : [ {
          "config" : {
            "invalidKeyPattern" : "\\s|\\$|\\{|\\}|\\\\",
            "logData" : "true",
            "name" : "nic-0-ip",
            "regex" : "(.+),.*,.*"
          },
          "type" : "key-value-data"
        }, {
          "config" : {
            "invalidKeyPattern" : "\\s|\\$|\\{|\\}|\\\\",
            "logData" : "true",
            "name" : "nic-0-mask",
            "regex" : ".*,(.+),.*"
          },
          "type" : "key-value-data"
        }, {
          "config" : {
            "invalidKeyPattern" : "\\s|\\$|\\{|\\}|\\\\",
            "logData" : "true",
            "name" : "nic-0-gw",
            "regex" : ".*,.*,(.+)"
          },
          "type" : "key-value-data"
        } ]
      },
      "type" : "localexec"
    }, {
      "configuration" : {
        "command" : "bash -c 'if [ \"${option.vnic-0-static}\" != \"static\" ]; then echo \"255.255.255.0\"; else true; fi'"
      },
      "description" : "Set netmask when dynamic",
      "nodeStep" : true,
      "plugins" : {
        "LogFilter" : [ {
          "config" : {
            "invalidKeyPattern" : "\\s|\\$|\\{|\\}|\\\\",
            "logData" : "true",
            "name" : "nic-0-mask",
            "regex" : "(.*)"
          },
          "type" : "key-value-data"
        } ]
      },
      "type" : "localexec"
    }, {
      "configuration" : {
        "command" : "bash -c 'if [ \"${option.vnic-1-static}\" != \"static\" ]; then echo \"255.255.255.0\"; else true; fi'"
      },
      "description" : "Set netmask when dynamic",
      "nodeStep" : true,
      "plugins" : {
        "LogFilter" : [ {
          "config" : {
            "invalidKeyPattern" : "\\s|\\$|\\{|\\}|\\\\",
            "logData" : "true",
            "name" : "nic-1-mask",
            "regex" : "(.*)"
          },
          "type" : "key-value-data"
        } ]
      },
      "type" : "localexec"
    }, {
      "configuration" : {
        "command" : "echo ovftool ${data.ovf-options*} --deploymentOption='${option.deployment-option}' --allowExtraConfig ${data.ovf-extra-config*} -n='${data.host-name*}' --numberOfCpus:'*'=${option.deploy-option-cpu} --memorySize:'*'=${option.deploy-option-mem} -ds='${data.datastore*}' --diskMode='thin' --net:vNIC0='${data.vnic-1-network}' --prop:ActiveVnics='${option.active-vnics}' --prop:ControllerIP='${export.mgtvip}' --prop:ControllerPort='${option.controller-port}' --prop:Label='${option.label}' --prop:Description='${option.description}' --prop:Vnic0IPv4Method='Static' --prop:Vnic1IPv4Method='None'   --prop:DNS='${data.dns-servers*}' --prop:NTP='${data.ntp-servers*}' --prop:Domain='${option.domain-name}' --prop:Hostname='${data.host-name*}' --prop:dg-operPassword='${option.dg-oper-password}' --prop:dg-adminPassword='${option.dg-admin-password}' --prop:ControllerSignCertChain='${data.certchain*}' --prop:ControllerCertChainPwd='${option.cnc-password}' --prop:Vnic0IPv4Address='${data.nic-0-ip*}${export.ip-1}' --prop:Vnic0IPv4Netmask='${data.nic-0-mask*}' --prop:Vnic0IPv4Gateway='${data.nic-0-gw*}${export.gw-1}' ${export.cdg-image} '''vi://${option.vcenter-username}:${option.vcenter-password}@${option.vcenter-host}${option.vmware-esx-host}'''"
      },
      "description" : "Generate Command Line",
      "nodeStep" : true,
      "plugins" : {
        "LogFilter" : [ {
          "config" : {
            "invalidKeyPattern" : "\\s|\\$|\\{|\\}|\\\\",
            "logData" : "true",
            "name" : "command-line",
            "regex" : "(.*)"
          },
          "type" : "key-value-data"
        } ]
      },
      "type" : "localexec"
    }, {
      "configuration" : {
        "debugOnly" : "false"
      },
      "nodeStep" : false,
      "type" : "log-data-step"
    }, {
      "description" : "If option is Execute, then run the command",
      "errorhandler" : {
        "keepgoingOnSuccess" : true,
        "script" : "@data.command-line*@"
      },
      "script" : "bash -c 'if [ \"@option.Option@\" == \"Execute\" ]; then false; else true; fi'"
    }, {
      "description" : "create rundeck node",
      "jobref" : {
        "args" : "-node-name ${data.host-name*} -hostname ${data.nic-0-ip*}${export.ip-1} -description \"${option.description}\" -user-name dg-admin -tags \"cdg,${data.pod-name*}-cdg\" -password-storage-path keys/cw/dg-admin",
        "group" : "Rundeck Nodes",
        "name" : "Create a New node",
        "uuid" : "e60e849d-c7c2-430e-a545-a2fb9b0a6c61"
      }
    } ],
    "keepgoing" : false,
    "strategy" : "sequential"
  },
  "uuid" : "288a4ffd-e44d-4d7b-b663-de65c6f351d0"
} ]
