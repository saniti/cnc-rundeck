- defaultTab: nodes
  description: ''
  executionEnabled: true
  group: CNC/Services/L3
  id: c0671c76-c4f8-4af7-8bea-80cb033ec554
  loglevel: INFO
  name: CNC - Create VPN  [L3]
  nodeFilterEditable: false
  notification:
    onsuccess:
      email:
        recipients: device-details@necehealthpoc.local
        subject: ${notification.eventStatus} ${job.name} ${option.service-name}
  notifyAvgDurationThreshold: null
  options:
  - enforced: true
    label: CW POD
    name: cnc-pod
    required: true
    valuesUrl: file:/opt/cw/options/cw-environments.json
  - enforced: true
    label: Service Type
    name: service-type
    required: true
    value: l3vpn
    values:
    - l3vpn
    valuesListDelimiter: ','
  - label: Service Name
    name: service-name
    required: true
  - hidden: true
    name: container
    value: '{"ietf-l3vpn-ntw:vpn-service":{"vpn-id":"xxx"}}'
  - hidden: true
    name: ie
    required: true
    value: '{"ietf-l3vpn-ntw:vpn-service":{"ie-profiles":{"ie-profile":[{"vpn-targets":{"vpn-target":[{"id":100,"route-targets":[{"route-target":"0:20:20"}],"route-target-type":"both"}],"vpn-policies":{"export-policy":"L3VPN_NM-SRTE-RP-PE1-7"}},"ie-profile-id":"DEMO2-PE1-PROFILE","rd":"0:101:1"},{"vpn-targets":{"vpn-target":[{"id":100,"route-targets":[{"route-target":"0:20:20"}],"route-target-type":"both"}]},"ie-profile-id":"DEMO2-PE2-PROFILE","rd":"0:101:2"},{"vpn-targets":{"vpn-target":[{"id":100,"route-targets":[{"route-target":"0:20:20"}],"route-target-type":"both"}]},"ie-profile-id":"DEMO2-PE3-PROFILE","rd":"0:101:3"},{"vpn-targets":{"vpn-target":[{"id":100,"route-targets":[{"route-target":"0:20:20"}],"route-target-type":"both"}]},"ie-profile-id":"DEMO2-P2-PROFILE","rd":"0:101:4"}]}}}'
  plugins:
    ExecutionLifecycle: null
  scheduleEnabled: true
  sequence:
    commands:
    - jobref:
        group: CNC/Configuration
        importOptions: true
        name: get key vars
        uuid: c3b0db66-3fdd-49b7-a5b5-4261a0ff3463
    - description: modify data
      plugins:
        LogFilter:
        - config:
            captureMultipleKeysValues: 'true'
            hideOutput: 'false'
            logData: 'true'
            regex: ^(.+?)\s*=\s*(.+)
          type: key-value-data-multilines
      script: |+
        echo '@option.container@' > /opt/cw/tmp/@job.execid@-container.json
        echo '@option.ie@' > /opt/cw/tmp/@job.execid@-ie.json

        container=$(jq -c '(..|objects|select(has("vpn-id")))."vpn-id" |= "@option.service-name@"' /opt/cw/tmp/@job.execid@-container.json)
        ie=$(jq -c '.' /opt/cw/tmp/@job.execid@-ie.json)
        echo data=$container
        echo ie=$ie


    - configuration:
        authentication: None
        body: ${data.data*}
        checkResponseCode: 'false'
        headers: |+
          {"Content-Type": "application/yang-data+json","Accept": "application/yang-data+json","Authorization": "Bearer ${export.cwtoken}"}




        method: PATCH
        printResponse: 'true'
        printResponseToFile: 'false'
        proxySettings: 'false'
        remoteUrl: https://${export.mgtvip}:30603/crosswork/proxy/nso/restconf/data/ietf-l3vpn-ntw:l3vpn-ntw/vpn-services/vpn-service
        sslVerify: 'false'
        timeout: '30000'
      nodeStep: false
      plugins:
        LogFilter:
        - config:
            invalidKeyPattern: \s|\$|\{|\}|\\
            logData: 'true'
            regex: ^RUNDECK:DATA:\s*([^\s]+?)\s*=\s*(.+)$
          type: key-value-data
      type: edu.ohio.ais.rundeck.HttpWorkflowStepPlugin
    - configuration:
        authentication: None
        body: ${data.ie*}
        checkResponseCode: 'false'
        headers: |+
          {"Content-Type": "application/yang-data+json","Accept": "application/yang-data+json","Authorization": "Bearer ${export.cwtoken}"}




        method: PATCH
        printResponse: 'true'
        printResponseToFile: 'false'
        proxySettings: 'false'
        remoteUrl: https://${export.mgtvip}:30603/crosswork/proxy/nso/restconf/data/ietf-l3vpn-ntw:l3vpn-ntw/vpn-services/vpn-service=${option.service-name}
        sslVerify: 'false'
        timeout: '30000'
      description: Create IE Profiles
      errorhandler:
        exec: echo hi
        keepgoingOnSuccess: true
      nodeStep: false
      plugins:
        LogFilter:
        - config:
            invalidKeyPattern: \s|\$|\{|\}|\\
            logData: 'true'
            regex: ^RUNDECK:DATA:\s*([^\s]+?)\s*=\s*(.+)$
          type: key-value-data
      type: edu.ohio.ais.rundeck.HttpWorkflowStepPlugin
    keepgoing: false
    strategy: node-first
  uuid: c0671c76-c4f8-4af7-8bea-80cb033ec554

