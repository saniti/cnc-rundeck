- defaultTab: nodes
  description: |-
    Deploy a standard 3 node crosswork cluster
    ## Features
    - IPAM integration
  executionEnabled: true
  group: CNC/Deploy/Batch
  id: afae11b4-a44f-44d7-8e0b-c2e8abaa3fd2
  loglevel: INFO
  name: Deploy CNC 3 Node
  nodeFilterEditable: false
  options:
  - label: Name of the seed host
    name: VM-1-Name
    required: true
    value: cw01
  - label: Name of the second host
    name: VM-2-Name
    required: true
    value: cw02
  - label: Name of third cluster node
    name: VM-3-Name
    required: true
    value: cw03
  - label: Upload VM Specification file
    name: vm01-spec
    type: file
  - label: Upload VM Specification file
    name: vm02-spec
    type: file
  - label: Upload VM Specification file
    name: vm03-spec
    type: file
  - enforced: true
    label: ESX Host (VM1)
    name: Host-1
    required: true
    valuesUrl: file:/tmp/hosts.json
  - enforced: true
    label: ESX Host (VM2)
    name: Host-2
    required: true
    valuesUrl: file:/tmp/hosts.json
  - enforced: true
    label: ESX Host (VM3)
    name: Host-3
    required: true
    valuesUrl: file:/tmp/hosts.json
  - enforced: true
    label: Datastore for VM1
    name: Datastore-1
    required: true
    valuesUrl: file:/tmp/datastores.json
  - enforced: true
    label: Datastore for VM2
    name: Datastore-2
    required: true
    valuesUrl: file:/tmp/datastores.json
  - enforced: true
    label: Datastore for VM3
    name: Datastore-3
    required: true
    valuesUrl: file:/tmp/datastores.json
  - hidden: true
    label: Data VIP Name
    name: DATAVIP-Name
    required: true
    value: dgwvip.ntf.local
  - hidden: true
    name: DNS
    required: true
    value: ' 192.168.226.19'
  - enforced: true
    name: DataNetwork
    required: true
    value: /HX-cluster/network/vm-network-413
    valuesUrl: file:/tmp/networks.json
  - hidden: true
    label: DNS Search Domain
    name: Domain
    required: true
    value: ntf.local
  - hidden: true
    name: Image
    required: true
    value: /opt/cw/images/cw-na-platform-4.1.0-38-release-211108v2.ova
    values:
    - /opt/cw/images/cw-na-platform-4.1.0-38-release-211108v2.ova
    valuesListDelimiter: ','
  - enforced: true
    name: ManagementNetwork
    required: true
    value: /HX-cluster/network/vm-network-411
    valuesUrl: file:/tmp/networks.json
  - hidden: true
    name: NTP
    required: true
    value: 192.168.203.203
  - label: DNS VIP Name
    name: VIP-Name
    required: true
    value: cwvip.ntf.local
  - enforced: true
    label: Number of CPUs
    name: vCPU
    required: true
    value: '8'
    values:
    - '16'
    - '2'
    - '4'
    - '8'
    valuesListDelimiter: ','
  - hidden: true
    name: vCenter-host
    required: true
    value: vcenter65.nbnncn.lab
  - hidden: true
    name: vCenter-passwd
    secure: true
    storagePath: keys/vmware/administrator-vc-local
    valueExposed: true
  - hidden: true
    name: vCenter-username
    required: true
    value: administrator@nbnncn.lab
  - enforced: true
    label: Memory in MB
    name: vMEM
    required: true
    value: '16392'
    values:
    - '16392'
    - '32768'
    - '4096'
    - '65536'
    - '8192'
    valuesListDelimiter: ','
  plugins:
    ExecutionLifecycle: null
  scheduleEnabled: true
  sequence:
    commands:
    - description: Create VM in Netbox
      jobref:
        args: -VM ${option.VM-1-Name}
        group: Netbox
        name: Add VM to NetBox
        uuid: acac2af5-f8a8-44d6-a8d7-d02b9356b452
    - description: Get VIP
      jobref:
        args: -search_tag cnc-mgmt -ifnum 99
        group: Netbox
        name: Assign IP to VM
        uuid: 0ff19321-403f-42bd-9ac1-ed2a4507b496
    - description: Get Management IP
      jobref:
        args: -search_tag cnc-mgmt -ifnum 1
        group: Netbox
        name: Assign IP to VM
        uuid: 0ff19321-403f-42bd-9ac1-ed2a4507b496
    - description: Get Data IP
      jobref:
        args: -search_tag cnc-device -ifnum 2
        group: Netbox
        name: Assign IP to VM
        uuid: 0ff19321-403f-42bd-9ac1-ed2a4507b496
    - description: Get Data VIP IP
      jobref:
        args: -search_tag cnc-device -ifnum 98
        group: Netbox
        name: Assign IP to VM
        uuid: 0ff19321-403f-42bd-9ac1-ed2a4507b496
    - description: Modify deployment file
      script: |-
        f1=/tmp/@option.VM-1-Name@.tmp.json
        f2=/tmp/@option.VM-1-Name@.json
        jq '.Name="@option.VM-1-Name@"' @file.vm01-spec@ > $f1
        jq '(.PropertyMapping[] | select(.Key=="ManagementIPv4Address")).Value |="@export.ip-1@"' $f1 > $f2
        jq '(.PropertyMapping[] | select(.Key=="DNSv4")).Value |="@option.DNS@"' $f2 > $f1
        jq '(.PropertyMapping[] | select(.Key=="NTP")).Value |="@option.NTP@"' $f1 > $f2
        jq '(.PropertyMapping[] | select(.Key=="ManagementVIPName")).Value |="@option.VIP-Name@"' $f2 > $f1
        jq '(.PropertyMapping[] | select(.Key=="ManagementIPv4Gateway")).Value |="@export.gw-1@"' $f1 > $f2
        jq '(.PropertyMapping[] | select(.Key=="DataIPv4Address")).Value |="@export.ip-2@"' $f2 > $f1
        jq '(.PropertyMapping[] | select(.Key=="DataIPv4Gateway")).Value |="@export.gw-2@"' $f1 > $f2
        jq '(.PropertyMapping[] | select(.Key=="ManagementVIP")).Value |="@export.ip-99@"' $f2 > $f1
        jq '(.PropertyMapping[] | select(.Key=="Domain")).Value |="@option.Domain@"' $f1 > $f2
        jq '(.PropertyMapping[] | select(.Key=="DataVIPName")).Value |="@option.DATAVIP-Name@"' $f2 > $f1
        jq '(.PropertyMapping[] | select(.Key=="DataVIP")).Value |="@export-ip-98@"' $f1 > $f2
        jq '(.NetworkMapping[] | select(.Name=="Management Network")).Network |="@option.ManagementNetwork@"' $f2 > $f1
        jq '(.NetworkMapping[] | select(.Name=="Data Network")).Network |="@option.DataNetwork@"' $f1 > $f2
        #cp -r $f1 $f2
    - description: Seed node
      exec: govc import.ova -k -name=${option.VM-1-Name} -options=/tmp/${option.VM-1-Name}.json
        -ds=${option.Datastore-1} -host=${option.Host-1} -u ${option.vCenter-username}:${option.vCenter-passwd}@${option.vCenter-host}
        ${option.Image}
    - description: Set Resources
      exec: govc vm.change -k -vm ${option.VM-1-Name} -u ${option.vCenter-username}:${option.vCenter-passwd}@${option.vCenter-host}
        -c=${option.vCPU} -m=${option.vMEM}
    - description: Power UP
      exec: govc vm.power -k -u ${option.vCenter-username}:${option.vCenter-passwd}@${option.vCenter-host}
        -on ${option.VM-1-Name}
    - description: Create VM in Netbox
      jobref:
        args: -VM ${option.VM-2-Name}
        group: Netbox
        name: Add VM to NetBox
        uuid: acac2af5-f8a8-44d6-a8d7-d02b9356b452
    - description: Get Management IP
      jobref:
        args: -search_tag cnc-mgmt -ifnum 3
        group: Netbox
        ignoreNotifications: true
        name: Assign IP to VM
        uuid: 0ff19321-403f-42bd-9ac1-ed2a4507b496
    - description: Get Data IP
      jobref:
        args: -search_tag cnc-device -ifnum 4
        group: Netbox
        name: Assign IP to VM
        uuid: 0ff19321-403f-42bd-9ac1-ed2a4507b496
    - description: Modify deployment file
      script: |-
        f1=/tmp/@option.VM-2-Name@.tmp.json
        f2=/tmp/@option.VM-2-Name@.json
        jq '.Name="@option.VM-2-Name@"' @file.vm02-spec@ > $f1
        jq '(.PropertyMapping[] | select(.Key=="ManagementIPv4Address")).Value |="@export.ip-3@"' $f1 > $f2
        jq '(.PropertyMapping[] | select(.Key=="DNSv4")).Value |="@option.DNS@"' $f2 > $f1
        jq '(.PropertyMapping[] | select(.Key=="NTP")).Value |="@option.NTP@"' $f1 > $f2
        jq '(.PropertyMapping[] | select(.Key=="ManagementVIPName")).Value |="@option.VIP-Name@"' $f2 > $f1
        jq '(.PropertyMapping[] | select(.Key=="ManagementIPv4Gateway")).Value |="@export.gw-3@"' $f1 > $f2
        jq '(.PropertyMapping[] | select(.Key=="DataIPv4Address")).Value |="@export.ip-4@"' $f2 > $f1
        jq '(.PropertyMapping[] | select(.Key=="DataIPv4Gateway")).Value |="@export.gw-4@"' $f1 > $f2
        jq '(.PropertyMapping[] | select(.Key=="ManagementVIP")).Value |="@export.ip-99@"' $f2 > $f1
        jq '(.PropertyMapping[] | select(.Key=="Domain")).Value |="@option.Domain@"' $f1 > $f2
        jq '(.PropertyMapping[] | select(.Key=="DataVIPName")).Value |="@option.DATAVIP-Name@"' $f2 > $f1
        jq '(.PropertyMapping[] | select(.Key=="DataVIP")).Value |="@export-ip-98@"' $f1 > $f2
        jq '(.NetworkMapping[] | select(.Name=="Management Network")).Network |="@option.ManagementNetwork@"' $f2 > $f1
        jq '(.NetworkMapping[] | select(.Name=="Data Network")).Network |="@option.DataNetwork@"' $f1 > $f2
        #cp -r $f1 $f2
    - description: Second node
      exec: govc import.ova -k -name=${option.VM-2-Name} -options=/tmp/${option.VM-2-Name}.json
        -ds=${option.Datastore-2} -host=${option.Host-2} -u ${option.vCenter-username}:${option.vCenter-passwd}@${option.vCenter-host}
        ${option.Image}
    - description: Set Resources
      exec: govc vm.change -k -vm ${option.VM-2-Name} -u ${option.vCenter-username}:${option.vCenter-passwd}@${option.vCenter-host}
        -c=${option.vCPU} -m=${option.vMEM}
    - description: Power UP
      exec: govc vm.power -k -u ${option.vCenter-username}:${option.vCenter-passwd}@${option.vCenter-host}
        -on ${option.VM-2-Name}
    - description: Create VM in Netbox
      jobref:
        args: -VM ${option.VM-3-Name}
        group: Netbox
        name: Add VM to NetBox
        uuid: acac2af5-f8a8-44d6-a8d7-d02b9356b452
    - description: Get Management IP
      jobref:
        args: -search_tag cnc-mgmt -ifnum 5
        group: Netbox
        ignoreNotifications: true
        name: Assign IP to VM
        uuid: 0ff19321-403f-42bd-9ac1-ed2a4507b496
    - description: Get Data IP
      jobref:
        args: -search_tag cnc-device -ifnum 6
        group: Netbox
        ignoreNotifications: true
        name: Assign IP to VM
        uuid: 0ff19321-403f-42bd-9ac1-ed2a4507b496
    - description: Modify deployment file
      script: |-
        f1=/tmp/@option.VM-3-Name@.tmp.json
        f2=/tmp/@option.VM-3-Name@.json
        jq '.Name="@option.VM-3-Name@"' @file.vm03-spec@ > $f1
        jq '(.PropertyMapping[] | select(.Key=="ManagementIPv4Address")).Value |="@export.ip-5@"' $f1 > $f2
        jq '(.PropertyMapping[] | select(.Key=="DNSv4")).Value |="@option.DNS@"' $f2 > $f1
        jq '(.PropertyMapping[] | select(.Key=="NTP")).Value |="@option.NTP@"' $f1 > $f2
        jq '(.PropertyMapping[] | select(.Key=="ManagementVIPName")).Value |="@option.VIP-Name@"' $f2 > $f1
        jq '(.PropertyMapping[] | select(.Key=="ManagementIPv4Gateway")).Value |="@export.gw-5@"' $f1 > $f2
        jq '(.PropertyMapping[] | select(.Key=="DataIPv4Address")).Value |="@export.ip-6@"' $f2 > $f1
        jq '(.PropertyMapping[] | select(.Key=="DataIPv4Gateway")).Value |="@export.gw-6@"' $f1 > $f2
        jq '(.PropertyMapping[] | select(.Key=="ManagementVIP")).Value |="@export.ip-99@"' $f2 > $f1
        jq '(.PropertyMapping[] | select(.Key=="Domain")).Value |="@option.Domain@"' $f1 > $f2
        jq '(.PropertyMapping[] | select(.Key=="DataVIPName")).Value |="@option.DATAVIP-Name@"' $f2 > $f1
        jq '(.PropertyMapping[] | select(.Key=="DataVIP")).Value |="@export-ip-98@"' $f1 > $f2
        jq '(.NetworkMapping[] | select(.Name=="Management Network")).Network |="@option.ManagementNetwork@"' $f2 > $f1
        jq '(.NetworkMapping[] | select(.Name=="Data Network")).Network |="@option.DataNetwork@"' $f1 > $f2
        #cp -r $f1 $f2
    - description: third node
      exec: govc import.ova -k -name=${option.VM-3-Name} -options=/tmp/${option.VM-3-Name}.json
        -ds=${option.Datastore-3} -host=${option.Host-3} -u ${option.vCenter-username}:${option.vCenter-passwd}@${option.vCenter-host}
        ${option.Image}
    - description: Set Resources
      exec: govc vm.change -k -vm ${option.VM-3-Name} -u ${option.vCenter-username}:${option.vCenter-passwd}@${option.vCenter-host}
        -c=${option.vCPU} -m=${option.vMEM}
    - description: Power UP
      exec: govc vm.power -k -u ${option.vCenter-username}:${option.vCenter-passwd}@${option.vCenter-host}
        -on ${option.VM-3-Name}
    keepgoing: false
    strategy: sequential
  uuid: afae11b4-a44f-44d7-8e0b-c2e8abaa3fd2

