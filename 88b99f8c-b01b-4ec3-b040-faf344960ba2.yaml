- defaultTab: nodes
  description: ''
  executionEnabled: true
  group: -DEMO/.working
  id: 88b99f8c-b01b-4ec3-b040-faf344960ba2
  loglevel: INFO
  name: CNC - Service
  nodeFilterEditable: false
  notification:
    onsuccess:
      email:
        recipients: device-details@necehealthpoc.local
        subject: ${notification.eventStatus} ${job.name}
  notifyAvgDurationThreshold: null
  options:
  - enforced: true
    label: CW POD
    name: cnc-pod
    required: true
    valuesUrl: file:/opt/cw/options/cw-environments.json
  - name: days
    required: true
  - label: Short name of CNC service
    name: service-name
    required: true
    value: dc-vpn-01
  - description: '> ITEF YANG Model'
    label: YANG path
    name: service-type
    required: true
    value: ietf-l3vpn-ntw:l3vpn-ntw/vpn-services/vpn-service
  plugins:
    ExecutionLifecycle: null
  scheduleEnabled: true
  sequence:
    commands:
    - description: get model name
      plugins:
        LogFilter:
        - config:
            captureMultipleKeysValues: 'true'
            hideOutput: 'false'
            logData: 'true'
            regex: ^(.+?)\s*=\s*(.+)
          type: key-value-data-multilines
      script: echo SERVICEMODEL=@option.service-type@=@option.service-name@
    - jobref:
        group: CNC/Configuration
        importOptions: true
        name: get key vars
        uuid: c3b0db66-3fdd-49b7-a5b5-4261a0ff3463
    - configuration:
        authentication: None
        body: '{"service_id":"${data.SERVICEMODEL*}","num_of_days":"${option.days}"}'
        checkResponseCode: 'false'
        file: /opt/cw/tmp/${job.execid}.json
        headers: |2+
           {"Content-Type": "application/json","Authorization": "Bearer ${export.cwtoken}"}

        method: POST
        printResponse: 'true'
        printResponseToFile: 'true'
        proxySettings: 'false'
        remoteUrl: https://${export.mgtvip}:30603/crosswork/aa/aaapp/v1/historicaltimeline
        sslVerify: 'false'
        timeout: '30000'
      description: get lsp data
      nodeStep: false
      type: edu.ohio.ais.rundeck.HttpWorkflowStepPlugin
    - description: get CSV
      script: |-
        file=/opt/cw/tmp/@job.execid@.json
        #jq -r '.lsps[]| [ keys[] as $k | .[$k] ]| @csv' $file

        #jq -r '[.elements[].attributes]  | (.[0] | keys_unsorted) as $keys |  ([$keys] + map([.[ $keys[] ]])) [] | @csv' $file
        jq -r '[.time_line_events[] |  (..|select(has("event_timestamp"))?).event_timestamp|=(.|tonumber/1000000000| gmtime| strflocaltime ("%Y-%m-%dT%H:%M:%SZ"))|del(.. | ."script"?)|  [ [leaf_paths as $path | {"key": $path | join("_"), "value": getpath($path)}] | from_entries ] []] |  (.[0] | keys_unsorted) as $keys |   ([$keys] + map([.[ $keys[] ]])) [] | @csv' $file
    keepgoing: false
    strategy: node-first
  uuid: 88b99f8c-b01b-4ec3-b040-faf344960ba2

