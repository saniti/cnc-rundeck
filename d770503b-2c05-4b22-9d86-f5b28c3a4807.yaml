- defaultTab: nodes
  description: Onboards a device without it being discovered via PCE
  executionEnabled: true
  group: CNC/Configuration
  id: d770503b-2c05-4b22-9d86-f5b28c3a4807
  loglevel: INFO
  name: CNC - Onboard Device - Basic
  nodeFilterEditable: false
  options:
  - enforced: true
    label: CNC POD
    name: cnc-pod
    required: true
    valuesUrl: file:/opt/cw/options/cw-environments.json
  - description: '> required'
    label: Device Name (short)
    name: device-name
    required: true
  - description: '> required'
    label: Device IPv4 Address
    name: device-ip
    required: true
  - description: '> required'
    enforced: true
    name: location-data
    required: true
    valuesUrl: file:/opt/cw/options/locations.json
  - label: Device subnet mask
    name: device-mask
    required: true
    value: '32'
  - label: SSH Port
    name: device-ssh-port
    required: true
    value: '22'
  - label: SNMP Port
    name: device-snmp-port
    required: true
    value: '161'
  - description: '- optional'
    label: Telemetry VRF
    name: telemetry_intf_src_vrf
  - description: '- optional'
    label: Router ID
    name: te_router_id
  - hidden: true
    name: cnc-password
    required: true
    secure: true
    storagePath: keys/cw/admin
    valueExposed: true
  - hidden: true
    label: CNC User Name
    name: cnc-user
    required: true
    value: admin
  - description: This should be hidden
    hidden: true
    name: provider-schema
    value: '{"data":[{"node_ip":{"inet_af":"ROBOT_INET_ADDR_TYPE_v4","inet_addr":"XXXX","mask":"32"},"host_name":"XXXX","profile":"device_profile","reachability_state":"CONN_STATE_REACHABLE","admin_state":"ROBOT_ADMIN_STATE_UP","connectivity_info":[{"type":"ROBOT_MSVC_TRANS_SSH","ipaddrs":[{"inet_af":"ROBOT_INET_ADDR_TYPE_v4","inet_addr":"XXXX","mask":"32"}],"port":"22","timeout":"120","reachability_state":"CONN_STATE_REACHABLE"},{"type":"ROBOT_MSVC_TRANS_SNMP","ipaddrs":[{"inet_af":"ROBOT_INET_ADDR_TYPE_v4","inet_addr":"XXXX","mask":"32"}],"port":"161","timeout":"120","reachability_state":"CONN_STATE_REACHABLE","snmpv3_engine_id":"aaaaaaaaaaaaaaaaa2650001"},{"type":"ROBOT_MSVC_TRANS_NETCONF","ipaddrs":[{"inet_af":"ROBOT_INET_ADDR_TYPE_v4","inet_addr":"XXXX","mask":"32"}],"port":830,"timeout":"30"},{"type":"ROBOT_MSVC_TRANS_GNMI","ipaddrs":[{"inet_af":"ROBOT_INET_ADDR_TYPE_v4","inet_addr":"XXXX","mask":"32"}],"port":57400,"timeout":"30","encoding_type":"PROTO"}],"product_info":{"software_type":"IOS
      XR","software_version":"7.5.1","product_type":"ciscoASR9906","product_family":"Aggregation
      Services Routers","product_series":"Cisco ASR9K Series","manufacturer":"Cisco
      Systems Inc.","sys_object_id":"1.3.6.1.4.1.9.1.2572","capability":["SNMP","GNMI","YANG_MDT","YANG_CLI"],"device_type":"NODE_TYPE_ROUTER","syslog_format":"RFC_UNKNOWN"},"geo_info":{"coordinates":{"latitude":{"value":"device-latitude"},"longitude":{"value":"device-longitude"}},"building":"","street":"","city":"","state":"","country":"","region":"","zip":""},"routing_info":{"telemetry_intf_src_name":"Loopback0","telemetry_intf_src_vrf":"default","telemetry_transport_type":"TCP_DIALOUT","telemetry_device_encoding":"GPBKV","te_router_id":""},"reachability_check":"REACH_CHECK_ENABLE","Inventory":{"sys_desc":"Cisco
      IOS XR Software (ASR9K), Version 7.5.1 Copyright (c) 2013-2021 by Cisco Systems,
      Inc.","sys_location":"STL-CALO"},"providers_family":{"ROBOT_PROVIDER_NSO":{"providers":{"NSO_CNC":{"provider_name":"NSO_CNC","provider_node_id":"XXXX"}}}}}]}'
  plugins:
    ExecutionLifecycle: null
  scheduleEnabled: true
  sequence:
    commands:
    - configuration:
        command: jq '.[] | select(.name=="${option.location-data}")."Longitude"' /opt/cw/options/locations.json
      description: get long
      nodeStep: true
      plugins:
        LogFilter:
        - config:
            invalidKeyPattern: \s|\$|\{|\}|\\
            logData: 'true'
            name: longitude
            regex: (.*)
          type: key-value-data
      type: localexec
    - configuration:
        command: jq '.[] | select(.name=="${option.location-data}")."Latitude"' /opt/cw/options/locations.json
      description: get lat
      nodeStep: true
      plugins:
        LogFilter:
        - config:
            invalidKeyPattern: \s|\$|\{|\}|\\
            logData: 'true'
            name: latitude
            regex: (.*)
          type: key-value-data
      type: localexec
    - configuration:
        command: jq '.[] | select(.name=="${option.location-data}")."Country"' /opt/cw/options/locations.json
      description: get country
      nodeStep: true
      plugins:
        LogFilter:
        - config:
            invalidKeyPattern: \s|\$|\{|\}|\\
            logData: 'true'
            name: country
            regex: '.([A-Z,a-z]+).+'
          type: key-value-data
      type: localexec
    - description: reconfigure JSON object
      plugins:
        LogFilter:
        - config:
            invalidKeyPattern: \s|\$|\{|\}|\\
            logData: 'true'
            name: payload
            regex: (.*)
          type: key-value-data
      script: |-
        file=/tmp/@job.execid@.json
        tmpfile=/tmp/@job.execid@.json.tmp

        echo '@option.provider-schema@' > $file
        jq '( .data[].geo_info.coordinates.longitude.value)|="@data.longitude*@"' $file > $tmpfile
        jq '( .data[].geo_info.coordinates.latitude.value)|="@data.latitude*@"' $tmpfile > $file
        jq '( .data[].geo_info.country)|="@data.country*@"' $file > $tmpfile
        jq '(..|objects|select(has("inet_addr")))."inet_addr"|= "@option.device-ip@"' $tmpfile > $file
        jq '(..|objects|select(has("host_name")))."host_name"|= "@option.device-name@"' $file > $tmpfile
        jq '(..|objects|select(has("mask")))."mask"|= "@option.device-mask@"' $tmpfile > $file
        jq '(..|objects|select(has("provider_node_id")))."provider_node_id"|= "@option.device-name@"' $file > $tmpfile
        jq '(..|objects|select(has("te_router_id")))."te_router_id"|= "@option.te_router_id@"' $tmpfile > $file
        jq '(..|objects|select(has("telemetry_intf_src_vrf")))."telemetry_intf_src_vrf"|= "@option.telemetry_intf_src_vrf@"' $file > $tmpfile
        jq '(..|objects|select(has("telemetry_intf_src_name")))."telemetry_intf_src_name"|= "@option.telemetry_intf_src_name@"' $tmpfile > $file
        jq '( .data[].connectivity_info[]|select(.type=="ROBOT_MSVC_TRANS_SNMP") ).port|="@option.device-snmp-port@"' $file > $tmpfile
        jq '( .data[].connectivity_info[]|select(.type=="ROBOT_MSVC_TRANS_SSH") ).port|="@option.device-ssh-port@"' $tmpfile > $file
        jq -c . $file
    - description: Get params
      jobref:
        args: -cnc-pod ${option.cnc-pod}
        group: CNC/Configuration
        name: get key vars
        uuid: c3b0db66-3fdd-49b7-a5b5-4261a0ff3463
    - configuration:
        authentication: None
        body: ${data.payload*}
        checkResponseCode: 'true'
        headers: '{"Content-Type": "application/json","Authorization": "Bearer ${export.cwtoken}"}'
        method: POST
        printResponse: 'true'
        printResponseToFile: 'false'
        proxySettings: 'false'
        remoteUrl: https://${export.mgtvip}:30603/crosswork/inventory/v1/nodes
        responseCode: '200'
        sslVerify: 'false'
        timeout: '30000'
      description: add device
      nodeStep: false
      type: edu.ohio.ais.rundeck.HttpWorkflowStepPlugin
    - configuration:
        authentication: None
        checkResponseCode: 'true'
        headers: '{"Content-Type": "application/json","Authorization": "Bearer ${export.cwtoken}"}'
        method: POST
        printResponse: 'true'
        printResponseToFile: 'false'
        proxySettings: 'false'
        remoteUrl: https://${export.mgtvip}:30603/crosswork/inventory/v1/nodes/query
        responseCode: '200'
        sslVerify: 'false'
        timeout: '30000'
      description: get devices
      nodeStep: false
      type: edu.ohio.ais.rundeck.HttpWorkflowStepPlugin
    - description: Attach to CDG
      jobref:
        group: CNC/Configuration
        importOptions: true
        name: Attach to CDG
        uuid: 5968d5f6-1127-434c-86f2-02ad4b3fd758
    keepgoing: false
    strategy: node-first
  uuid: d770503b-2c05-4b22-9d86-f5b28c3a4807

