[ {
  "defaultTab" : "nodes",
  "description" : "Create a new Git repository\n---\n### Inputs\nno inputs are required. This service will simply access git and obtain a list of repositories (all)\n\n- the output will be a JSON file, used as the input for the repository list\n- if repository list changes, re-run this process\n",
  "executionEnabled" : true,
  "group" : "DMO/DMO - Service Creation",
  "id" : "4de54123-abf0-4a87-a3a9-d6f67c1dc1a6",
  "loglevel" : "INFO",
  "name" : "0.99 - [Git] - create new repository",
  "nodeFilterEditable" : false,
  "options" : [ {
    "description" : "> Must not exist",
    "label" : "Repository Name",
    "name" : "repo-name",
    "required" : true
  }, {
    "label" : "Description",
    "name" : "descr",
    "required" : true
  }, {
    "hidden" : true,
    "name" : "token",
    "required" : true,
    "secure" : true,
    "storagePath" : "keys/gitea/token",
    "valueExposed" : true
  }, {
    "label" : "Default Branch",
    "name" : "default_branch",
    "required" : true,
    "value" : "main",
    "values" : [ "main", "master" ],
    "valuesListDelimiter" : ","
  }, {
    "label" : "Development Branch",
    "name" : "develop_branch",
    "required" : true,
    "value" : "develop",
    "values" : [ "develop" ],
    "valuesListDelimiter" : ","
  }, {
    "enforced" : true,
    "name" : "license",
    "sortValues" : true,
    "value" : "MIT",
    "values" : [ "MIT" ],
    "valuesListDelimiter" : ","
  }, {
    "hidden" : true,
    "name" : "git",
    "required" : true,
    "secure" : true,
    "storagePath" : "keys/git/repo",
    "valueExposed" : true
  } ],
  "plugins" : {
    "ExecutionLifecycle" : null
  },
  "scheduleEnabled" : true,
  "sequence" : {
    "commands" : [ {
      "configuration" : {
        "authentication" : "None",
        "body" : "{\n  \"auto_init\": true,\n  \"default_branch\": \"${option.default_branch}\",\n  \"description\": \"${option.descr}\",\n  \"gitignores\": \"\",\n  \"issue_labels\": \"\",\n  \"license\": \"${option.license}\",\n  \"name\": \"${option.repo-name}\",\n  \"private\": true,\n  \"readme\": \"Default\",\n  \"template\": false,\n  \"trust_model\": \"default\"\n}",
        "checkResponseCode" : "false",
        "file" : "/opt/cw/tmp/${job.execid}-newrepo.json",
        "headers" : "{\"accept\": \"application/json\",\"Content-Type\": \"application/json\",\"Authorization\":\"Bearer ${option.token}\"}",
        "method" : "POST",
        "printResponse" : "true",
        "printResponseToFile" : "true",
        "proxySettings" : "false",
        "remoteUrl" : "${option.git}/api/v1/user/repos",
        "sslVerify" : "false",
        "timeout" : "30000"
      },
      "description" : "create new repo",
      "nodeStep" : false,
      "type" : "edu.ohio.ais.rundeck.HttpWorkflowStepPlugin"
    }, {
      "description" : "get repo properties",
      "plugins" : {
        "LogFilter" : [ {
          "config" : {
            "captureMultipleKeysValues" : "true",
            "hideOutput" : "false",
            "logData" : "true",
            "regex" : "^(.+?)\\s*=\\s*(.+)"
          },
          "type" : "key-value-data-multilines"
        } ]
      },
      "script" : "file=/opt/cw/tmp/@job.execid@-newrepo.json\njq -r '. | \"id=\"+(.id|tostring)' $file\njq -r '. | \"fullname=\"+(.full_name|tostring)' $file\njq -r '. | \"name=\"+(.name|tostring)' $file\njq -r '. | \"owner=\"+(.owner.login|tostring)' $file"
    }, {
      "configuration" : {
        "authentication" : "None",
        "body" : "{\"new_branch_name\": \"${option.develop_branch}\",  \"old_branch_name\": \"${option.default_branch}\"}",
        "checkResponseCode" : "false",
        "file" : "/opt/cw/tmp/${job.execid}-gitrepos.json",
        "headers" : "{\"accept\": \"application/json\",\"Content-Type\": \"application/json\",\"Authorization\":\"Bearer ${option.token}\"}",
        "method" : "POST",
        "printResponse" : "true",
        "printResponseToFile" : "false",
        "proxySettings" : "false",
        "remoteUrl" : "${option.git}/api/v1/repos/${data.owner*}/${data.name*}/branches",
        "sslVerify" : "false",
        "timeout" : "30000"
      },
      "description" : "create deveoper branch",
      "nodeStep" : false,
      "type" : "edu.ohio.ais.rundeck.HttpWorkflowStepPlugin"
    }, {
      "description" : "update repo list",
      "jobref" : {
        "group" : "git",
        "name" : "git - create repo list",
        "uuid" : "37da7e27-068e-4bac-80b0-bd503f702416"
      }
    }, {
      "description" : "update default branch file list",
      "jobref" : {
        "args" : "-repo ${data.fullname*} -branch ${option.default_branch}",
        "group" : "git",
        "name" : "git - generate file list",
        "uuid" : "4f9035c3-ed9d-487a-9c3c-4885403b0116"
      }
    }, {
      "description" : "update develop branch file list",
      "jobref" : {
        "args" : "-repo ${data.fullname*} -branch ${option.develop_branch}",
        "group" : "git",
        "name" : "git - generate file list",
        "uuid" : "4f9035c3-ed9d-487a-9c3c-4885403b0116"
      }
    } ],
    "keepgoing" : false,
    "strategy" : "node-first"
  },
  "uuid" : "4de54123-abf0-4a87-a3a9-d6f67c1dc1a6"
} ]
